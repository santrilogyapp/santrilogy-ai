<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:defaultwidgetversion='2' b:layoutsVersion='3' b:responsive='true' b:templateUrl='indie.xml' b:templateVersion='1.0.0' expr:dir='data:blog.languageDirection' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
  <head>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover' name='viewport'/>
    <meta content='yes' name='apple-mobile-web-app-capable'/>
    <meta content='yes' name='mobile-web-app-capable'/>
    <meta content='black-translucent' name='apple-mobile-web-app-status-bar-style'/>
    <title><data:blog.pageTitle/></title>
    
    <link href='https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;family=Amiri:wght@400;700&amp;family=Noto+Sans+Arabic:wght@400;500;700&amp;display=swap' rel='stylesheet'/>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css' rel='stylesheet'/>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css' rel='stylesheet'/>
    <script src='https://cdn.jsdelivr.net/npm/marked/marked.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js'></script>

    <b:skin><![CDATA[
      /* ============================================
         SANTRILOGY AI - ULTRA PREMIUM STYLESHEET
         Version 3.0 - Complete Overhaul
         ============================================ */
      
      :root {
        /* Light Theme */
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --bg-glass: rgba(255,255,255,0.85);
        --bg-modal: rgba(255,255,255,0.98);
        --bg-code: #1e293b;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-muted: #94a3b8;
        --text-inverse: #ffffff;

        /* Accent Colors */
        --accent: #6366f1;
        --accent-hover: #4f46e5;
        --accent-soft: rgba(99,102,241,0.1);
        --accent-2: #8b5cf6;
        --accent-3: #06b6d4;
        --accent-4: #10b981;
        --accent-5: #f59e0b;
        --accent-6: #ef4444;
        --accent-7: #ec4899;

        /* Gradients */
        --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
        --gradient-2: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-3: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-4: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-5: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --gradient-6: linear-gradient(180deg, transparent 0%, var(--bg-primary) 100%);

        /* Borders & Shadows */
        --border: rgba(0,0,0,0.08);
        --border-light: rgba(0,0,0,0.04);
        --border-focus: rgba(99,102,241,0.5);
        --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
        --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
        --shadow-xl: 0 20px 60px rgba(0,0,0,0.15);
        --shadow-glow: 0 0 40px rgba(99,102,241,0.3);

        /* Radius */
        --radius-xs: 8px;
        --radius-sm: 12px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --radius-xl: 32px;
        --radius-full: 9999px;

        /* Layout */
        --header-h: 64px;
        --input-h: 140px;
        --sidebar-w: 300px;
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-top: env(safe-area-inset-top, 0px);

        /* Typography */
        --font-xs: 11px;
        --font-sm: 13px;
        --font-base: 15px;
        --font-md: 16px;
        --font-lg: 18px;
        --font-xl: 24px;
        --font-2xl: 32px;
        --font-3xl: 40px;
        --font-arabic: 'Amiri', 'Noto Sans Arabic', 'Scheherazade New', 'Traditional Arabic', serif;

        /* Animations */
        --transition-fast: 0.15s ease;
        --transition-base: 0.25s ease;
        --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Dark Theme */
      [data-theme="dark"] {
        --bg-primary: #0a0a0b;
        --bg-secondary: #111113;
        --bg-tertiary: #1a1a1d;
        --bg-glass: rgba(17,17,19,0.92);
        --bg-modal: rgba(17,17,19,0.98);
        --bg-code: #0d1117;
        --text-primary: #f8fafc;
        --text-secondary: #a1a1aa;
        --text-muted: #52525b;
        --border: rgba(255,255,255,0.1);
        --border-light: rgba(255,255,255,0.05);
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
        --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
        --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
      }

      /* ===== BASE RESET ===== */
      *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html {
        scroll-behavior: smooth;
        -webkit-text-size-adjust: 100%;
      }

      body {
        font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
        transition: background var(--transition-base), color var(--transition-base);
        font-size: var(--font-base);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Background Effects */
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: 
          radial-gradient(ellipse 80% 50% at 20% -20%, rgba(99,102,241,0.08) 0%, transparent 50%),
          radial-gradient(ellipse 60% 40% at 80% 100%, rgba(139,92,246,0.06) 0%, transparent 50%),
          radial-gradient(ellipse 40% 30% at 50% 50%, rgba(6,182,212,0.04) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
      }

      a { text-decoration: none; color: inherit; }
      button { font-family: inherit; cursor: pointer; border: none; background: none; }
      input, textarea { font-family: inherit; }
      img { max-width: 100%; height: auto; }
      
      /* Hide Blogger Elements */
      .navbar, .attribution, #blog-pager, .post-footer, .post-header, 
      .blog-feeds, .feed-links { display: none !important; }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { 
        background: var(--text-muted); 
        border-radius: 10px; 
      }
      ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

      /* Selection */
      ::selection {
        background: var(--accent);
        color: white;
      }

      /* ===== ATOM LOGO SYSTEM ===== */
      .atom-logo {
        width: 44px;
        height: 44px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .atom-nucleus {
        width: 10px;
        height: 10px;
        background: var(--gradient-1);
        border-radius: 50%;
        position: absolute;
        box-shadow: 0 0 20px var(--accent), 0 0 40px rgba(99,102,241,0.3);
        animation: nucleusPulse 2s ease-in-out infinite;
      }

      .atom-orbit {
        position: absolute;
        border: 1.5px solid;
        border-radius: 50%;
        animation: orbitSpin 3s linear infinite;
      }

      .atom-orbit::after {
        content: '';
        position: absolute;
        width: 6px;
        height: 6px;
        background: currentColor;
        border-radius: 50%;
        top: -3px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 0 8px currentColor;
      }

      .orbit-1 {
        width: 30px;
        height: 30px;
        border-color: rgba(99,102,241,0.5);
        color: #6366f1;
        animation-duration: 2s;
      }

      .orbit-2 {
        width: 36px;
        height: 20px;
        border-color: rgba(139,92,246,0.5);
        color: #8b5cf6;
        animation-duration: 2.5s;
        transform: rotate(60deg);
        animation-name: orbitSpin2;
      }

      .orbit-3 {
        width: 36px;
        height: 20px;
        border-color: rgba(6,182,212,0.5);
        color: #06b6d4;
        animation-duration: 3s;
        transform: rotate(-60deg);
        animation-name: orbitSpin3;
      }

      @keyframes nucleusPulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 20px var(--accent), 0 0 40px rgba(99,102,241,0.3); }
        50% { transform: scale(1.2); box-shadow: 0 0 30px var(--accent), 0 0 60px rgba(99,102,241,0.4); }
      }

      @keyframes orbitSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes orbitSpin2 { from { transform: rotate(60deg); } to { transform: rotate(420deg); } }
      @keyframes orbitSpin3 { from { transform: rotate(-60deg); } to { transform: rotate(300deg); } }

      /* Large Atom */
      .atom-lg {
        width: 120px;
        height: 120px;
      }

      .atom-lg .atom-nucleus {
        width: 22px;
        height: 22px;
      }

      .atom-lg .orbit-1 { width: 70px; height: 70px; }
      .atom-lg .orbit-2, .atom-lg .orbit-3 { width: 95px; height: 50px; }
      .atom-lg .atom-orbit::after { width: 12px; height: 12px; top: -6px; }

      /* Mini Atom */
      .atom-mini {
        width: 100%;
        height: 100%;
      }

      .atom-mini .atom-nucleus {
        width: 5px;
        height: 5px;
        background: white;
        box-shadow: 0 0 8px rgba(255,255,255,0.5);
      }

      .atom-mini .atom-orbit { border-width: 1px; }
      .atom-mini .orbit-1 { width: 22px; height: 22px; border-color: rgba(255,255,255,0.6); }
      .atom-mini .orbit-2, .atom-mini .orbit-3 { width: 26px; height: 14px; }
      .atom-mini .atom-orbit::after { width: 4px; height: 4px; top: -2px; background: white; box-shadow: none; }

      /* ===== LAYOUT STRUCTURE ===== */
      .app {
        display: flex;
        height: 100vh;
        height: 100dvh;
        position: relative;
        overflow: hidden;
      }

      /* Overlay */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 150;
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-base);
      }

      .overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* ===== SIDEBAR ===== */
      .sidebar {
        width: var(--sidebar-w);
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        height: 100%;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 200;
        transition: transform var(--transition-slow);
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: var(--header-h);
      }

      .logo-wrap {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .logo-text {
        font-size: var(--font-lg);
        font-weight: 800;
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
      }

      .logo-badge {
        font-size: 9px;
        font-weight: 700;
        background: var(--gradient-1);
        color: white;
        padding: 3px 8px;
        border-radius: var(--radius-full);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .sidebar-close {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border-radius: var(--radius-xs);
        color: var(--text-muted);
        transition: var(--transition-fast);
      }

      .sidebar-close:hover {
        background: var(--border);
        color: var(--text-primary);
        transform: rotate(90deg);
      }

      /* New Chat Button */
      .new-chat-btn {
        margin: 20px;
        padding: 16px;
        background: var(--gradient-1);
        border-radius: var(--radius-md);
        color: white;
        font-size: var(--font-sm);
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: var(--transition-base);
        box-shadow: 0 4px 20px rgba(99,102,241,0.3);
        position: relative;
        overflow: hidden;
      }

      .new-chat-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(99,102,241,0.4);
      }

      .new-chat-btn:hover::before {
        transform: translateX(100%);
      }

      .new-chat-btn:active {
        transform: translateY(0) scale(0.98);
      }

      /* Sidebar Navigation */
      .sidebar-nav {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
      }

      .nav-group {
        margin-bottom: 20px;
      }

      .nav-label {
        font-size: var(--font-xs);
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 10px 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 13px 14px;
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: var(--font-sm);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-fast);
        width: 100%;
        text-align: left;
        position: relative;
      }

      .nav-item:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .nav-item.active {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .nav-item.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 60%;
        background: var(--accent);
        border-radius: 0 3px 3px 0;
      }

      .nav-item i {
        width: 20px;
        text-align: center;
        font-size: 16px;
      }

      .nav-item .badge {
        margin-left: auto;
        font-size: 10px;
        font-weight: 700;
        background: var(--accent);
        color: white;
        padding: 3px 8px;
        border-radius: var(--radius-full);
      }

      .nav-item .badge.new {
        background: var(--accent-6);
        animation: badgePulse 2s infinite;
      }

      @keyframes badgePulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      /* History Items */
      .history-list {
        max-height: 200px;
        overflow-y: auto;
      }

      .history-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 11px 14px;
        border-radius: var(--radius-xs);
        color: var(--text-secondary);
        font-size: var(--font-sm);
        cursor: pointer;
        transition: var(--transition-fast);
        position: relative;
      }

      .history-item:hover {
        background: var(--bg-tertiary);
      }

      .history-item i { 
        font-size: 14px; 
        color: var(--text-muted);
      }

      .history-item span {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .history-item .delete-history {
        opacity: 0;
        color: var(--accent-6);
        font-size: 12px;
        padding: 4px;
        transition: var(--transition-fast);
      }

      .history-item:hover .delete-history {
        opacity: 1;
      }

      /* Sidebar Footer */
      .sidebar-footer {
        padding: 16px;
        border-top: 1px solid var(--border);
        position: relative;
      }

      .storage-info {
        margin-bottom: 12px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
      }

      .storage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .storage-label {
        font-size: var(--font-xs);
        font-weight: 600;
        color: var(--text-secondary);
      }

      .storage-value {
        font-size: var(--font-xs);
        color: var(--text-muted);
      }

      .storage-bar {
        height: 4px;
        background: var(--border);
        border-radius: var(--radius-full);
        overflow: hidden;
      }

      .storage-fill {
        height: 100%;
        background: var(--gradient-1);
        border-radius: var(--radius-full);
        transition: width 0.5s ease;
      }

      .profile-card {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .profile-card:hover {
        background: var(--bg-tertiary);
      }

      .profile-avatar {
        width: 44px;
        height: 44px;
        background: var(--gradient-1);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: var(--font-md);
        position: relative;
      }

      .profile-avatar .online-dot {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        background: #22c55e;
        border: 2px solid var(--bg-primary);
        border-radius: 50%;
      }

      .profile-info {
        flex: 1;
        min-width: 0;
      }

      .profile-name {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .profile-plan {
        font-size: var(--font-xs);
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .profile-plan i {
        color: var(--accent-5);
        font-size: 10px;
      }

      #profileChevron {
        color: var(--text-muted);
        font-size: 12px;
        transition: transform var(--transition-base);
      }

      /* Settings Dropdown */
      .settings-dropdown {
        position: absolute;
        bottom: calc(100% + 10px);
        left: 16px;
        right: 16px;
        background: var(--bg-modal);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-xl);
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95);
        transform-origin: bottom center;
        transition: var(--transition-base);
        z-index: 500;
        overflow: hidden;
      }

      .settings-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .dropdown-header {
        padding: 16px 18px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .dropdown-title {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
      }

      .dropdown-close {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border-radius: var(--radius-xs);
        color: var(--text-muted);
        font-size: 12px;
        transition: var(--transition-fast);
      }

      .dropdown-close:hover {
        background: var(--border);
        color: var(--text-primary);
        transform: rotate(90deg);
      }

      .dropdown-body {
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px;
        border-radius: var(--radius-xs);
        transition: var(--transition-fast);
        cursor: pointer;
      }

      .dropdown-item:hover {
        background: var(--bg-tertiary);
      }

      .dropdown-item-label {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--text-primary);
      }

      .dropdown-item-label i {
        width: 20px;
        text-align: center;
        color: var(--text-muted);
        font-size: 16px;
      }

      .dropdown-item-desc {
        font-size: var(--font-xs);
        color: var(--text-muted);
        margin-top: 2px;
      }

      .dropdown-divider {
        height: 1px;
        background: var(--border-light);
        margin: 8px 0;
      }

      /* Toggle Switches */
      .toggle-mini {
        width: 44px;
        height: 24px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: var(--transition-base);
        border: 2px solid var(--border);
      }

      .toggle-mini::after {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        top: 1px;
        left: 1px;
        transition: var(--transition-base);
        box-shadow: var(--shadow-sm);
      }

      .toggle-mini.on {
        background: var(--accent);
        border-color: var(--accent);
      }

      .toggle-mini.on::after {
        transform: translateX(20px);
      }

      /* Color Pills */
      .color-pills {
        display: flex;
        gap: 8px;
      }

      .color-pill {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: var(--transition-fast);
        position: relative;
      }

      .color-pill:hover {
        transform: scale(1.15);
      }

      .color-pill.active {
        border-color: var(--text-primary);
      }

      .color-pill.active::after {
        content: 'âœ“';
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 10px;
        font-weight: bold;
      }

      .c-indigo { background: #6366f1; }
      .c-blue { background: #3b82f6; }
      .c-green { background: #10b981; }
      .c-purple { background: #8b5cf6; }
      .c-pink { background: #ec4899; }
      .c-orange { background: #f97316; }
      .c-custom { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }

      /* ===== MAIN CONTENT ===== */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        margin-left: var(--sidebar-w);
        transition: margin-left var(--transition-slow);
        position: relative;
      }

      .sidebar.collapsed ~ .main {
        margin-left: 0;
      }

      /* Header */
      .header {
        height: var(--header-h);
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 100;
        padding-top: var(--safe-top);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .menu-btn, .icon-btn {
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 18px;
        transition: var(--transition-fast);
        position: relative;
      }

      .menu-btn:hover, .icon-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .icon-btn.has-notification::after {
        content: '';
        position: absolute;
        top: 10px;
        right: 10px;
        width: 8px;
        height: 8px;
        background: var(--accent-6);
        border-radius: 50%;
        border: 2px solid var(--bg-primary);
      }

      .model-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius-full);
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .model-selector:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .model-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
        animation: dotPulse 2s infinite;
      }

      @keyframes dotPulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
      }

      .model-name {
        font-size: var(--font-xs);
        font-weight: 700;
        color: var(--text-secondary);
      }

      .model-selector i {
        font-size: 10px;
        color: var(--text-muted);
        transition: transform var(--transition-base);
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* More Dropdown */
      .more-dropdown {
        position: absolute;
        top: calc(var(--header-h) + 8px);
        right: 20px;
        background: var(--bg-modal);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-xl);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px) scale(0.95);
        transform-origin: top right;
        transition: var(--transition-base);
        z-index: 500;
        overflow: hidden;
        min-width: 240px;
      }

      .more-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      /* Model Dropdown */
      .model-dropdown {
        position: absolute;
        top: calc(var(--header-h) + 8px);
        left: 70px;
        background: var(--bg-modal);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-xl);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px) scale(0.95);
        transform-origin: top left;
        transition: var(--transition-base);
        z-index: 500;
        overflow: hidden;
        min-width: 280px;
      }

      .model-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .model-option {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 18px;
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .model-option:hover {
        background: var(--bg-tertiary);
      }

      .model-option.active {
        background: var(--accent-soft);
      }

      .model-option-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .model-option-info h4 {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .model-option-info p {
        font-size: var(--font-xs);
        color: var(--text-muted);
      }

      .model-option .check-icon {
        margin-left: auto;
        color: var(--accent);
        opacity: 0;
      }

      .model-option.active .check-icon {
        opacity: 1;
      }

      /* ===== CHAT AREA ===== */
      .chat-area {
        flex: 1;
        overflow-y: auto;
        overscroll-behavior: contain;
        padding: 28px 20px;
        padding-bottom: calc(var(--input-h) + 30px);
        scroll-behavior: smooth;
      }

      .chat-container {
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
      }

      /* Messages */
      .post-outer {
        margin-bottom: 32px;
        animation: messageIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes messageIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .msg {
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }

      .msg-avatar {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-weight: 700;
        font-size: var(--font-sm);
      }

      .msg-avatar.ai {
        background: var(--gradient-1);
        box-shadow: 0 4px 15px rgba(99,102,241,0.3);
      }

      .msg-avatar.user {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 2px solid var(--border);
      }

      .msg-body {
        flex: 1;
        min-width: 0;
      }

      .msg-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }

      .msg-name {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
      }

      .msg-time {
        font-size: var(--font-xs);
        color: var(--text-muted);
      }

      .msg-badge {
        font-size: 9px;
        font-weight: 700;
        background: var(--gradient-1);
        color: white;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        text-transform: uppercase;
      }

      /* Post Body / Message Content */
      .post-body {
        font-size: var(--font-base);
        line-height: 1.8;
        color: var(--text-primary);
      }

      .post-body p {
        margin-bottom: 12px;
      }

      .post-body p:last-child {
        margin-bottom: 0;
      }

      /* Code Blocks */
      .post-body pre {
        background: var(--bg-code);
        border-radius: var(--radius-sm);
        padding: 0;
        margin: 16px 0;
        overflow: hidden;
        position: relative;
      }

      .code-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        background: rgba(255,255,255,0.05);
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      .code-lang {
        font-size: var(--font-xs);
        font-weight: 600;
        color: rgba(255,255,255,0.6);
        text-transform: uppercase;
      }

      .code-copy {
        font-size: var(--font-xs);
        color: rgba(255,255,255,0.6);
        background: rgba(255,255,255,0.1);
        padding: 4px 10px;
        border-radius: var(--radius-xs);
        cursor: pointer;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .code-copy:hover {
        background: rgba(255,255,255,0.2);
        color: white;
      }

      .code-copy.copied {
        background: var(--accent-4);
        color: white;
      }

      .post-body pre code {
        display: block;
        padding: 16px;
        overflow-x: auto;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 13px;
        line-height: 1.6;
        color: #e6e6e6;
        background: transparent;
      }

      /* Inline Code */
      .post-body code:not(pre code) {
        background: var(--bg-tertiary);
        padding: 3px 8px;
        border-radius: 6px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9em;
        color: var(--accent);
        border: 1px solid var(--border);
      }

      /* Text Formatting */
      .post-body strong {
        font-weight: 700;
        color: var(--text-primary);
      }

      .post-body em {
        font-style: italic;
        color: var(--text-secondary);
      }

      /* Lists */
      .post-body ul, .post-body ol {
        margin: 12px 0;
        padding-left: 24px;
      }

      .post-body li {
        margin-bottom: 8px;
        position: relative;
      }

      .post-body ul li::marker {
        color: var(--accent);
      }

      .post-body ol li::marker {
        color: var(--accent);
        font-weight: 600;
      }

      /* Links */
      .post-body a {
        color: var(--accent);
        text-decoration: underline;
        text-underline-offset: 3px;
        transition: var(--transition-fast);
      }

      .post-body a:hover {
        color: var(--accent-hover);
      }

      /* Blockquotes */
      .post-body blockquote {
        margin: 16px 0;
        padding: 16px 20px;
        background: var(--bg-tertiary);
        border-left: 4px solid var(--accent);
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        color: var(--text-secondary);
        font-style: italic;
      }

      /* ARABIC TEXT FIX - Simple inline styling without background/border */
      .post-body .arabic {
        font-family: var(--font-arabic);
        font-size: 1em; /* Ukuran sepadan dengan teks Latin */
        line-height: 1.8; /* Jarak antar baris yang sesuai */
        direction: rtl; /* Arah baca kanan ke kiri */
        display: inline; /* Hindari menumpuk vertikal */
        unicode-bidi: embed; /* Penting untuk rendering karakter Arab */
        color: inherit;
      }

      /* Fix untuk layout jika Arab ada di dalam tabel */
      .table-responsive .arabic {
        white-space: nowrap; /* Di dalam tabel jangan wrap */
        display: inline;
      }

      /* Base styling for elements that may contain Arabic text */
      .post-body p,
      .post-body div,
      .post-body span,
      .post-body li {
        unicode-bidi: plaintext;
      }

      /* Tables */
      .post-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 16px 0;
        font-size: var(--font-sm);
      }

      .post-body th, .post-body td {
        padding: 12px;
        border: 1px solid var(--border);
        text-align: left;
      }

      .post-body th {
        background: var(--bg-tertiary);
        font-weight: 700;
      }

      .post-body tr:nth-child(even) {
        background: var(--bg-secondary);
      }

      /* Message Actions */
      .msg-actions {
        display: flex;
        gap: 6px;
        margin-top: 14px;
        opacity: 0;
        transition: var(--transition-fast);
      }

      .msg:hover .msg-actions {
        opacity: 1;
      }

      .msg-action-btn {
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border-radius: var(--radius-xs);
        color: var(--text-muted);
        font-size: 14px;
        transition: var(--transition-fast);
      }

      .msg-action-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .msg-action-btn.liked {
        background: rgba(239,68,68,0.1);
        color: var(--accent-6);
      }

      /* Typing Indicator */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 0;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--accent);
        border-radius: 50%;
        animation: typingBounce 1.4s ease-in-out infinite both;
      }

      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes typingBounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }

      /* ===== WELCOME SCREEN ===== */
      .welcome {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 65vh;
        text-align: center;
        padding: 40px 24px;
        position: relative;
      }

      .welcome-glow {
        position: absolute;
        width: 200px;
        height: 200px;
        background: var(--gradient-1);
        filter: blur(100px);
        opacity: 0.2;
        animation: glowFloat 6s ease-in-out infinite;
        pointer-events: none;
      }

      @keyframes glowFloat {
        0%, 100% { transform: scale(1) translate(0, 0); }
        33% { transform: scale(1.1) translate(20px, -20px); }
        66% { transform: scale(0.9) translate(-20px, 20px); }
      }

      .welcome-logo {
        position: relative;
        margin-bottom: 32px;
        z-index: 1;
      }

      .welcome h1 {
        font-size: var(--font-3xl);
        font-weight: 800;
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
        letter-spacing: -1px;
      }

      .welcome .subtitle {
        font-size: var(--font-lg);
        color: var(--text-secondary);
        max-width: 420px;
        margin-bottom: 40px;
        line-height: 1.6;
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 36px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .quick-action {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-full);
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .quick-action:hover {
        border-color: var(--accent);
        color: var(--accent);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .quick-action i {
        font-size: 16px;
      }

      /* Suggestions Grid */
      .suggestions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
        width: 100%;
        max-width: 560px;
      }

      .sug-card {
        padding: 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        text-align: left;
        cursor: pointer;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
      }

      .sug-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-1);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform var(--transition-base);
      }

      .sug-card:hover {
        border-color: var(--accent);
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .sug-card:hover::before {
        transform: scaleX(1);
      }

      .sug-card:active {
        transform: translateY(-2px) scale(0.98);
      }

      .sug-icon {
        width: 44px;
        height: 44px;
        background: var(--accent-soft);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        font-size: 18px;
        margin-bottom: 14px;
      }

      .sug-card:nth-child(2) .sug-icon {
        background: rgba(139,92,246,0.1);
        color: var(--accent-2);
      }

      .sug-card:nth-child(3) .sug-icon {
        background: rgba(16,185,129,0.1);
        color: var(--accent-4);
      }

      .sug-card:nth-child(4) .sug-icon {
        background: rgba(245,158,11,0.1);
        color: var(--accent-5);
      }

      .sug-title {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 6px;
      }

      .sug-desc {
        font-size: var(--font-xs);
        color: var(--text-muted);
        line-height: 1.5;
      }

      /* ===== INPUT AREA ===== */
      .input-area {
        position: fixed;
        bottom: 0;
        left: var(--sidebar-w);
        right: 0;
        background: var(--gradient-6);
        padding: 20px;
        padding-bottom: calc(20px + var(--safe-bottom));
        z-index: 100;
        transition: left var(--transition-slow);
      }

      .sidebar.collapsed ~ .main .input-area {
        left: 0;
      }

      .input-wrap {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
      }

      /* Tools Dropdown (Desktop) */
      .tools-dropdown {
        position: absolute;
        bottom: calc(100% + 12px);
        left: 0;
        width: 360px;
        background: var(--bg-modal);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95);
        transform-origin: bottom left;
        transition: var(--transition-base);
        z-index: 500;
        overflow: hidden;
      }

      .tools-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .dropdown-section {
        padding: 16px;
        border-bottom: 1px solid var(--border-light);
      }

      .dropdown-section:last-child {
        border-bottom: none;
      }

      .dropdown-label {
        font-size: var(--font-xs);
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
      }

      .dropdown-upload {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .upload-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px 12px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition-fast);
        border: 1px solid transparent;
      }

      .upload-item:hover {
        border-color: var(--accent);
        background: var(--accent-soft);
        transform: translateY(-2px);
      }

      .upload-item i {
        font-size: 22px;
        color: var(--accent);
      }

      .upload-item span {
        font-size: var(--font-xs);
        font-weight: 600;
        color: var(--text-primary);
      }

      .dropdown-tools {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .tool-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: var(--radius-xs);
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .tool-item:hover {
        background: var(--bg-tertiary);
      }

      .tool-item i {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-soft);
        border-radius: var(--radius-xs);
        color: var(--accent);
        font-size: 16px;
      }

      .tool-item span {
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Input Box */
      .input-box {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: var(--bg-secondary);
        border: 2px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 12px 14px;
        transition: var(--transition-base);
        box-shadow: var(--shadow-md);
      }

      .input-box:focus-within {
        border-color: var(--accent);
        box-shadow: var(--shadow-lg), 0 0 0 4px var(--accent-soft);
      }

      .input-left, .input-right {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        gap: 4px;
      }

      .input-btn {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        font-size: 20px;
        transition: var(--transition-fast);
        position: relative;
      }

      .input-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }

      .input-btn.active {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .input-btn.plus {
        color: var(--accent);
      }

      .input-btn.plus:hover {
        background: var(--accent-soft);
      }

      .input-field {
        flex: 1;
        border: none;
        background: transparent;
        font-family: inherit;
        font-size: var(--font-base);
        line-height: 1.5;
        color: var(--text-primary);
        resize: none;
        outline: none;
        min-height: 26px;
        max-height: 150px;
        padding: 9px 0;
      }

      .input-field::placeholder {
        color: var(--text-muted);
      }

      /* Action Button */
      .send-mic-btn {
        width: 46px;
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        font-size: 18px;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
      }

      .send-mic-btn.mic {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }

      .send-mic-btn.mic:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .send-mic-btn.mic.recording {
        background: var(--accent-6);
        color: white;
        animation: recordPulse 1s infinite;
      }

      @keyframes recordPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }

      .send-mic-btn.send {
        background: var(--gradient-1);
        color: white;
        box-shadow: 0 4px 15px rgba(99,102,241,0.4);
        transform: scale(1.05);
      }

      .send-mic-btn.send:hover {
        box-shadow: 0 6px 20px rgba(99,102,241,0.5);
        transform: scale(1.1);
      }

      .send-mic-btn.send:active {
        transform: scale(1);
      }

      /* Input Footer */
      .input-footer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
        font-size: var(--font-xs);
        color: var(--text-muted);
      }

      .input-footer a {
        color: var(--accent);
        font-weight: 600;
      }

      /* Character Counter */
      .char-counter {
        position: absolute;
        bottom: -24px;
        right: 0;
        font-size: var(--font-xs);
        color: var(--text-muted);
      }

      .char-counter.warning {
        color: var(--accent-5);
      }

      .char-counter.danger {
        color: var(--accent-6);
      }

      /* ===== MOBILE MODALS ===== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 500;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition-base);
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .mobile-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-modal);
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        padding: 0 20px 20px;
        z-index: 501;
        transform: translateY(100%);
        transition: transform var(--transition-slow);
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .mobile-modal.show {
        transform: translateY(0);
      }

      .modal-handle {
        width: 40px;
        height: 5px;
        background: var(--border);
        border-radius: var(--radius-full);
        margin: 12px auto 16px;
        flex-shrink: 0;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
        flex-shrink: 0;
      }

      .modal-title {
        font-size: var(--font-lg);
        font-weight: 700;
        color: var(--text-primary);
      }

      .modal-close {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border-radius: var(--radius-xs);
        color: var(--text-muted);
        transition: var(--transition-fast);
      }

      .modal-close:hover {
        background: var(--border);
        color: var(--text-primary);
      }

      .modal-body {
        overflow-y: auto;
        flex: 1;
        padding-bottom: var(--safe-bottom);
      }

      .modal-section-title {
        font-size: var(--font-xs);
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 14px;
      }

      /* Tools Grid (Mobile) */
      .tools-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .tool-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 20px 14px;
        cursor: pointer;
        transition: var(--transition-fast);
        text-align: center;
      }

      .tool-card:hover {
        transform: translateY(-3px);
        background: var(--bg-primary);
        border-color: var(--accent);
        box-shadow: var(--shadow-md);
      }

      .tool-card:active {
        transform: scale(0.96);
      }

      .tool-icon {
        width: 50px;
        height: 50px;
        background: var(--accent-soft);
        color: var(--accent);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        margin-bottom: 12px;
      }

      .tool-label {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.3;
      }

      .tool-desc {
        font-size: var(--font-xs);
        color: var(--text-muted);
        margin-top: 4px;
      }

      /* Mobile Settings */
      .mobile-setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 0;
        border-bottom: 1px solid var(--border-light);
      }

      .mobile-setting-item:last-child {
        border-bottom: none;
      }

      .mobile-setting-label {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .mobile-setting-label i {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border-radius: var(--radius-xs);
        color: var(--text-secondary);
        font-size: 18px;
      }

      .mobile-setting-label span {
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--text-primary);
      }

      .toggle-switch {
        width: 52px;
        height: 30px;
        background: var(--bg-tertiary);
        border-radius: 15px;
        position: relative;
        transition: var(--transition-base);
        cursor: pointer;
      }

      .toggle-switch::after {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: var(--transition-base);
        box-shadow: var(--shadow-sm);
      }

      .toggle-switch.on {
        background: var(--accent);
      }

      .toggle-switch.on::after {
        transform: translateX(22px);
      }

      /* ===== TOAST NOTIFICATIONS ===== */
      .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: var(--bg-modal);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-lg);
        animation: toastIn 0.3s ease-out;
        min-width: 280px;
        max-width: 400px;
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .toast.hiding {
        animation: toastOut 0.3s ease-out forwards;
      }

      @keyframes toastOut {
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      .toast-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-xs);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }

      .toast.success .toast-icon {
        background: rgba(16,185,129,0.1);
        color: var(--accent-4);
      }

      .toast.error .toast-icon {
        background: rgba(239,68,68,0.1);
        color: var(--accent-6);
      }

      .toast.warning .toast-icon {
        background: rgba(245,158,11,0.1);
        color: var(--accent-5);
      }

      .toast.info .toast-icon {
        background: rgba(99,102,241,0.1);
        color: var(--accent);
      }

      .toast-content {
        flex: 1;
        min-width: 0;
      }

      .toast-title {
        font-size: var(--font-sm);
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .toast-message {
        font-size: var(--font-xs);
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .toast-close {
        color: var(--text-muted);
        font-size: 14px;
        padding: 4px;
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .toast-close:hover {
        color: var(--text-primary);
      }

      /* ===== LOADING STATES ===== */
      .skeleton {
        background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--radius-xs);
      }

      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      /* ===== RESPONSIVE ===== */
      @media (max-width: 1024px) {
        .sidebar {
          width: 85%;
          max-width: 320px;
        }
        
        .main {
          margin-left: 0 !important;
        }
        
        .input-area {
          left: 0 !important;
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 0 16px;
        }

        .model-selector span {
          display: none;
        }

        .model-selector {
          padding: 10px 12px;
        }

        .chat-area {
          padding: 20px 16px;
          padding-bottom: calc(var(--input-h) + 20px);
        }

        .welcome h1 {
          font-size: var(--font-2xl);
        }

        .suggestions {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .quick-actions {
          flex-direction: column;
          width: 100%;
          max-width: 300px;
        }

        .quick-action {
          width: 100%;
          justify-content: center;
        }

        .tools-dropdown {
          display: none !important;
        }

        .input-area {
          padding: 16px;
        }

        .input-box {
          padding: 10px 12px;
        }

        .msg-actions {
          opacity: 1;
        }

        .toast-container {
          left: 16px;
          right: 16px;
        }

        .toast {
          min-width: auto;
        }
      }

      @media (max-width: 480px) {
        .msg-header .msg-badge {
          display: none;
        }

        .input-btn {
          width: 40px;
          height: 40px;
          font-size: 18px;
        }

        .send-mic-btn {
          width: 42px;
          height: 42px;
        }
      }

      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Print Styles */
      @media print {
        .sidebar, .header, .input-area, .msg-actions {
          display: none !important;
        }
        
        .main {
          margin: 0 !important;
        }
        
        .chat-area {
          padding: 20px !important;
        }
      }

/* ============================================
   MARKDOWN & TABLE STYLES (NEW)
   ============================================ */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  margin: 16px 0;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg-tertiary);
  -webkit-overflow-scrolling: touch;
}

.table-responsive table {
  margin: 0;
  border: none;
  width: 100%;
  border-collapse: collapse;
}

.table-responsive th,
.table-responsive td {
  white-space: nowrap;
  padding: 12px 16px;
}
    ]]></b:skin>
  </head>
  
  <body>
    <!-- Toast Container -->
    <div class='toast-container' id='toastContainer'/>

    <div class='app'>
      <!-- Overlay -->
      <div class='overlay' id='overlay' onclick='closeSidebar()'/>

      <!-- Sidebar -->
      <aside class='sidebar' id='sidebar'>
        <div class='sidebar-header'>
          <div class='logo-wrap'>
            <div class='atom-logo'>
              <div class='atom-nucleus'/>
              <div class='atom-orbit orbit-1'/>
              <div class='atom-orbit orbit-2'/>
              <div class='atom-orbit orbit-3'/>
            </div>
            <div>
              <span class='logo-text'>Santrilogy</span>
              <span class='logo-badge'>AI</span>
            </div>
          </div>
          <button aria-label='Close sidebar' class='sidebar-close' onclick='closeSidebar()'>
            <i class='fas fa-times'/>
          </button>
        </div>

        <button class='new-chat-btn' onclick='startNewChat()'>
          <i class='fas fa-plus'/> Percakapan Baru
        </button>

        <nav class='sidebar-nav'>
          <div class='nav-group'>
            <div class='nav-label'>
              <i class='fas fa-compass' style='font-size: 10px;'/> Menu Utama
            </div>
            <button class='nav-item active' data-nav='chat'>
              <i class='fas fa-message'/>
              <span>Chat AI</span>
            </button>
            <button class='nav-item' data-nav='explore'>
              <i class='fas fa-sparkles'/>
              <span>Jelajahi</span>
              <span class='badge new'>New</span>
            </button>
            <button class='nav-item' data-nav='library'>
              <i class='fas fa-book-open'/>
              <span>Pustaka Kitab</span>
            </button>
            <button class='nav-item' data-nav='quiz'>
              <i class='fas fa-brain'/>
              <span>Kuis &amp; Latihan</span>
            </button>
          </div>

          <div class='nav-group'>
            <div class='nav-label'>
              <i class='fas fa-clock' style='font-size: 10px;'/> Riwayat
            </div>
            <div class='history-list' id='historyList'>
              <div class='history-item'>
                <i class='fas fa-message'/>
                <span>Hukum Air Musta&#39;mal</span>
                <button class='delete-history' onclick='deleteHistory(0)'><i class='fas fa-times'/></button>
              </div>
              <div class='history-item'>
                <i class='fas fa-message'/>
                <span>Terjemah Fathul Qorib</span>
                <button class='delete-history' onclick='deleteHistory(1)'><i class='fas fa-times'/></button>
              </div>
              <div class='history-item'>
                <i class='fas fa-message'/>
                <span>I&#39;rob Alfiyah bait 1</span>
                <button class='delete-history' onclick='deleteHistory(2)'><i class='fas fa-times'/></button>
              </div>
            </div>
            <button class='nav-item' onclick='viewAllHistory()'>
              <i class='fas fa-clock-rotate-left'/>
              <span>Lihat Semua</span>
            </button>
          </div>

          <div class='nav-group'>
            <div class='nav-label'>
              <i class='fas fa-cog' style='font-size: 10px;'/> Lainnya
            </div>
            <button class='nav-item' onclick='openMobileSettings()'>
              <i class='fas fa-gear'/>
              <span>Pengaturan</span>
            </button>
            <button class='nav-item' onclick='showUpgradeModal()'>
              <i class='fas fa-crown'/>
              <span>Upgrade Pro</span>
              <span class='badge' style='background: var(--gradient-3);'>50% OFF</span>
            </button>
            <button class='nav-item' onclick='showHelpModal()'>
              <i class='fas fa-circle-question'/>
              <span>Bantuan</span>
            </button>
          </div>
        </nav>

        <div class='sidebar-footer'>
          <!-- Storage Info -->
          <div class='storage-info'>
            <div class='storage-header'>
              <span class='storage-label'>Penyimpanan Chat</span>
              <span class='storage-value' id='storageValue'>12/50 chat</span>
            </div>
            <div class='storage-bar'>
              <div class='storage-fill' id='storageFill' style='width: 24%;'/>
            </div>
          </div>

          <!-- Settings Dropdown -->
          <div class='settings-dropdown' id='settingsDropdown'>
            <div class='dropdown-header'>
              <span class='dropdown-title'>&#9881;&#65039; Pengaturan</span>
              <button class='dropdown-close' onclick='closeSettingsDropdown()'>
                <i class='fas fa-times'/>
              </button>
            </div>
            <div class='dropdown-body'>
              <div class='dropdown-item' onclick='toggleDarkMode()'>
                <div>
                  <div class='dropdown-item-label'>
                    <i class='fas fa-moon'/>
                    <span>Mode Gelap</span>
                  </div>
                  <div class='dropdown-item-desc'>Nyaman untuk mata di malam hari</div>
                </div>
                <button class='toggle-mini' id='darkToggleDesktop'/>
              </div>
              
              <div class='dropdown-item' onclick='toggleAutoSave()'>
                <div>
                  <div class='dropdown-item-label'>
                    <i class='fas fa-cloud'/>
                    <span>Simpan Otomatis</span>
                  </div>
                  <div class='dropdown-item-desc'>Simpan riwayat chat otomatis</div>
                </div>
                <button class='toggle-mini on' id='autoSaveToggle'/>
              </div>

              <div class='dropdown-item' onclick='toggleSound()'>
                <div>
                  <div class='dropdown-item-label'>
                    <i class='fas fa-volume-high'/>
                    <span>Efek Suara</span>
                  </div>
                  <div class='dropdown-item-desc'>Notifikasi dan feedback</div>
                </div>
                <button class='toggle-mini on' id='soundToggle'/>
              </div>

              <div class='dropdown-divider'/>

              <div class='dropdown-item'>
                <div class='dropdown-item-label'>
                  <i class='fas fa-palette'/>
                  <span>Tema Warna</span>
                </div>
                <div class='color-pills'>
                  <button class='color-pill c-indigo active' data-color='#6366f1' onclick='applyThemeColor(this)'/>
                  <button class='color-pill c-blue' data-color='#3b82f6' onclick='applyThemeColor(this)'/>
                  <button class='color-pill c-green' data-color='#10b981' onclick='applyThemeColor(this)'/>
                  <button class='color-pill c-purple' data-color='#8b5cf6' onclick='applyThemeColor(this)'/>
                  <button class='color-pill c-pink' data-color='#ec4899' onclick='applyThemeColor(this)'/>
                  <button class='color-pill c-custom' onclick='openColorPicker()' title='Pilih Warna'/>
                </div>
              </div>

              <div class='dropdown-item'>
                <div class='dropdown-item-label'>
                  <i class='fas fa-text-height'/>
                  <span>Ukuran Font</span>
                </div>
                <div style='display: flex; gap: 6px;'>
                  <button class='font-size-btn' onclick='setFontSize(&quot;small&quot;)' style='padding: 4px 10px; border-radius: 6px; background: var(--bg-tertiary); font-size: 12px;'>A-</button>
                  <button class='font-size-btn active' onclick='setFontSize(&quot;medium&quot;)' style='padding: 4px 10px; border-radius: 6px; background: var(--accent); color: white; font-size: 14px;'>A</button>
                  <button class='font-size-btn' onclick='setFontSize(&quot;large&quot;)' style='padding: 4px 10px; border-radius: 6px; background: var(--bg-tertiary); font-size: 16px;'>A+</button>
                </div>
              </div>

              <div class='dropdown-divider'/>

              <div class='dropdown-item' onclick='exportChats()'>
                <div class='dropdown-item-label'>
                  <i class='fas fa-download'/>
                  <span>Ekspor Chat</span>
                </div>
              </div>

              <div class='dropdown-item' onclick='clearAllChats()'>
                <div class='dropdown-item-label'>
                  <i class='fas fa-trash' style='color: var(--accent-6);'/>
                  <span style='color: var(--accent-6);'>Hapus Semua Chat</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Card -->
          <div class='profile-card' onclick='toggleSettings()'>
            <div class='profile-avatar'>
              S
              <div class='online-dot'/>
            </div>
            <div class='profile-info'>
              <div class='profile-name'>Santri User</div>
              <div class='profile-plan'>
                <i class='fas fa-star'/>
                Free Plan
              </div>
            </div>
            <i class='fas fa-chevron-up' id='profileChevron'/>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <div class='main'>
        <!-- Header -->
        <header class='header'>
          <div class='header-left'>
            <button aria-label='Toggle menu' class='menu-btn' onclick='toggleSidebar()'>
              <i class='fas fa-bars'/>
            </button>
            
            <div class='model-selector' onclick='toggleModelDropdown()'>
              <div class='model-dot'/>
              <span class='model-name' id='currentModel'>Santrilogy Pro</span>
              <i class='fas fa-chevron-down' id='modelChevron'/>
            </div>
          </div>
          
          <div class='header-right'>
            <button class='icon-btn' onclick='toggleSearch()' title='Cari'>
              <i class='fas fa-search'/>
            </button>
            <button class='icon-btn has-notification' onclick='showNotifications()' title='Notifikasi'>
              <i class='fas fa-bell'/>
            </button>
            <button class='icon-btn' onclick='toggleMoreDropdown()' title='Lainnya'>
              <i class='fas fa-ellipsis-vertical'/>
            </button>
          </div>
        </header>

        <!-- Model Dropdown -->
        <div class='model-dropdown' id='modelDropdown'>
          <div class='dropdown-header'>
            <span class='dropdown-title'>Pilih Model AI</span>
          </div>
          <div class='model-option active' onclick='selectModel(&quot;pro&quot;, this)'>
            <div class='model-option-icon' style='background: var(--gradient-1); color: white;'>
              <i class='fas fa-bolt'/>
            </div>
            <div class='model-option-info'>
              <h4>Santrilogy Pro</h4>
              <p>Respon cepat &amp; akurat untuk semua pertanyaan</p>
            </div>
            <i class='fas fa-check check-icon'/>
          </div>
          <div class='model-option' onclick='selectModel(&quot;turbo&quot;, this)'>
            <div class='model-option-icon' style='background: var(--gradient-4); color: white;'>
              <i class='fas fa-rocket'/>
            </div>
            <div class='model-option-info'>
              <h4>Santrilogy Turbo</h4>
              <p>Super cepat untuk chat ringan</p>
            </div>
            <i class='fas fa-check check-icon'/>
          </div>
          <div class='model-option' onclick='selectModel(&quot;scholar&quot;, this)'>
            <div class='model-option-icon' style='background: var(--gradient-5); color: white;'>
              <i class='fas fa-graduation-cap'/>
            </div>
            <div class='model-option-info'>
              <h4>Santrilogy Scholar</h4>
              <p>Analisis mendalam untuk kajian kitab</p>
            </div>
            <i class='fas fa-check check-icon'/>
          </div>
        </div>

        <!-- More Dropdown -->
        <div class='more-dropdown' id='moreDropdown'>
          <div class='dropdown-body'>
            <div class='dropdown-item' onclick='shareChat()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-share-alt'/>
                <span>Bagikan Chat</span>
              </div>
            </div>
            <div class='dropdown-item' onclick='pinChat()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-thumbtack'/>
                <span>Pin Percakapan</span>
              </div>
            </div>
            <div class='dropdown-item' onclick='renameChat()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-pen'/>
                <span>Ubah Judul</span>
              </div>
            </div>
            <div class='dropdown-divider'/>
            <div class='dropdown-item' onclick='downloadApp()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-download'/>
                <span>Install Aplikasi</span>
              </div>
            </div>
            <div class='dropdown-item' onclick='showKeyboardShortcuts()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-keyboard'/>
                <span>Pintasan Keyboard</span>
              </div>
            </div>
            <div class='dropdown-divider'/>
            <div class='dropdown-item' onclick='showPrivacyPolicy()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-shield-halved'/>
                <span>Kebijakan Privasi</span>
              </div>
            </div>
            <div class='dropdown-item' onclick='showTerms()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-file-contract'/>
                <span>Syarat &amp; Ketentuan</span>
              </div>
            </div>
            <div class='dropdown-item' onclick='showAbout()'>
              <div class='dropdown-item-label'>
                <i class='fas fa-info-circle'/>
                <span>Tentang Santrilogy</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div class='chat-area' id='chatArea'>
          <div class='chat-container' id='chatContainer'>
            <b:section id='main' showaddelement='yes'>
              <b:widget id='Blog1' locked='true' title='Postingan Blog' type='Blog' version='2' visible='true'>
                <b:widget-settings>
                  <b:widget-setting name='showDateHeader'>false</b:widget-setting>
                  <b:widget-setting name='style.textcolor'>#ffffff</b:widget-setting>
                  <b:widget-setting name='showShareButtons'>false</b:widget-setting>
                  <b:widget-setting name='showCommentLink'>false</b:widget-setting>
                  <b:widget-setting name='style.urlcolor'>#ffffff</b:widget-setting>
                  <b:widget-setting name='showAuthor'>false</b:widget-setting>
                  <b:widget-setting name='style.linkcolor'>#ffffff</b:widget-setting>
                  <b:widget-setting name='style.unittype'>TextAndImage</b:widget-setting>
                  <b:widget-setting name='style.bgcolor'>#ffffff</b:widget-setting>
                  <b:widget-setting name='reactionsLabel'/>
                  <b:widget-setting name='showAuthorProfile'>false</b:widget-setting>
                  <b:widget-setting name='style.layout'>1x1</b:widget-setting>
                  <b:widget-setting name='showLabels'>false</b:widget-setting>
                  <b:widget-setting name='showLocation'>false</b:widget-setting>
                  <b:widget-setting name='showTimestamp'>false</b:widget-setting>
                  <b:widget-setting name='postsPerAd'>1</b:widget-setting>
                  <b:widget-setting name='showBacklinks'>false</b:widget-setting>
                  <b:widget-setting name='style.bordercolor'>#ffffff</b:widget-setting>
                  <b:widget-setting name='showInlineAds'>false</b:widget-setting>
                  <b:widget-setting name='showReactions'>false</b:widget-setting>
                </b:widget-settings>
                <b:includable id='main'>
                  <b:if cond='data:posts.notEmpty'>
                    <b:loop values='data:posts' var='post'>
                      <div class='post-outer'>
                        <div class='msg'>
                          <div class='msg-avatar ai'>
                            <div class='atom-mini'>
                              <div class='atom-nucleus'/>
                              <div class='atom-orbit orbit-1'/>
                            </div>
                          </div>
                          <div class='msg-body'>
                            <div class='msg-header'>
                              <span class='msg-name'>Santrilogy AI</span>
                              <span class='msg-time'>Arsip</span>
                              <span class='msg-badge'>PRO</span>
                            </div>
                            <div class='post-body'>
                              <data:post.body/>
                            </div>
                            <div class='msg-actions'>
                              <button class='msg-action-btn' onclick='copyMessage(this)' title='Salin'>
                                <i class='fas fa-copy'/>
                              </button>
                              <button class='msg-action-btn' onclick='likeMessage(this)' title='Suka'>
                                <i class='fas fa-heart'/>
                              </button>
                              <button class='msg-action-btn' onclick='shareMessage(this)' title='Bagikan'>
                                <i class='fas fa-share'/>
                              </button>
                              <button class='msg-action-btn' onclick='regenerateMessage(this)' title='Regenerate'>
                                <i class='fas fa-rotate'/>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </b:loop>
                  <b:else/>
                    <!-- Welcome Screen -->
                    <div class='welcome' id='welcomeScreen'>
                      <div class='welcome-glow'/>
                      <div class='welcome-logo'>
                        <div class='atom-logo atom-lg'>
                          <div class='atom-nucleus'/>
                          <div class='atom-orbit orbit-1'/>
                          <div class='atom-orbit orbit-2'/>
                          <div class='atom-orbit orbit-3'/>
                        </div>
                      </div>
                      <h1>Santrilogy AI</h1>
                      <p class='subtitle'>Assalamualaikum! Saya Santrilogy AI, teman diskusi virtualmu. Mau diskusi apa hari ini?</p>
                      
                      <!-- Quick Actions -->
                      <div class='quick-actions'>
                        <button class='quick-action' onclick='startVoiceChat()'>
                          <i class='fas fa-microphone'/>
                          <span>Mulai dengan Suara</span>
                        </button>
                        <button class='quick-action' onclick='uploadImage()'>
                          <i class='fas fa-camera'/>
                          <span>Scan Kitab</span>
                        </button>
                      </div>

                      <!-- Suggestions -->
                      <div class='suggestions'>
                        <div class='sug-card' onclick='askQuestion(&quot;Jelaskan hukum air musta&apos;mal dalam fikih Syafi&apos;i&quot;)'>
                          <div class='sug-icon'><i class='fas fa-water'/></div>
                          <div class='sug-title'>Fikih Thaharah</div>
                          <div class='sug-desc'>Hukum air musta&#39;mal dan pembagiannya</div>
                        </div>
                        <div class='sug-card' onclick='askQuestion(&quot;Terjemahkan dan jelaskan Fathul Qorib Bab Wudhu&quot;)'>
                          <div class='sug-icon'><i class='fas fa-book'/></div>
                          <div class='sug-title'>Terjemah Kitab</div>
                          <div class='sug-desc'>Fathul Qorib, Safinatun Najah, dll</div>
                        </div>
                        <div class='sug-card' onclick='askQuestion(&quot;Berikan analisis i&apos;rob dari bait pertama Alfiyah Ibn Malik&quot;)'>
                          <div class='sug-icon'><i class='fas fa-diagram-project'/></div>
                          <div class='sug-title'>Analisis I&#39;rob</div>
                          <div class='sug-desc'>Nahwu dan struktur kalimat Arab</div>
                        </div>
                        <div class='sug-card' onclick='askQuestion(&quot;Jelaskan wazan fi&apos;il dan tasrif lughowi&quot;)'>
                          <div class='sug-icon'><i class='fas fa-language'/></div>
                          <div class='sug-title'>Ilmu Shorof</div>
                          <div class='sug-desc'>Perubahan bentuk kata Arab</div>
                        </div>
                      </div>
                    </div>
                  </b:if>
                </b:includable>
                <b:includable id='aboutPostAuthor'/>
                <b:includable id='addComments'/>
                <b:includable id='blogThisShare'/>
                <b:includable id='bylineByName' var='byline'/>
                <b:includable id='bylineRegion' var='regionItems'/>
                <b:includable id='commentAuthorAvatar'/>
                <b:includable id='commentDeleteIcon' var='comment'/>
                <b:includable id='commentForm' var='post'/>
                <b:includable id='commentFormIframeSrc' var='post'/>
                <b:includable id='commentItem' var='comment'/>
                <b:includable id='commentList' var='comments'/>
                <b:includable id='commentPicker' var='post'/>
                <b:includable id='comments' var='post'/>
                <b:includable id='commentsLink'/>
                <b:includable id='commentsLinkIframe'/>
                <b:includable id='commentsTitle'/>
                <b:includable id='defaultAdUnit'/>
                <b:includable id='emailPostIcon'/>
                <b:includable id='facebookShare'/>
                <b:includable id='feedLinks'/>
                <b:includable id='feedLinksBody' var='links'/>
                <b:includable id='footerBylines'/>
                <b:includable id='googlePlusShare'/>
                <b:includable id='headerByline'/>
                <b:includable id='homePageLink'/>
                <b:includable id='iframeComments' var='post'/>
                <b:includable id='inlineAd' var='post'/>
                <b:includable id='linkShare'/>
                <b:includable id='nextPageLink'/>
                <b:includable id='otherSharingButton'/>
                <b:includable id='platformShare'/>
                <b:includable id='post' var='post'/>
                <b:includable id='postAuthor'/>
                <b:includable id='postBody' var='post'/>
                <b:includable id='postBodySnippet' var='post'/>
                <b:includable id='postCommentsAndAd' var='post'/>
                <b:includable id='postCommentsLink'/>
                <b:includable id='postFooter' var='post'/>
                <b:includable id='postFooterAuthorProfile' var='post'/>
                <b:includable id='postHeader' var='post'/>
                <b:includable id='postJumpLink' var='post'/>
                <b:includable id='postLabels'/>
                <b:includable id='postLocation'/>
                <b:includable id='postMeta' var='post'/>
                <b:includable id='postMetadataJSONImage'/>
                <b:includable id='postMetadataJSONPublisher'/>
                <b:includable id='postPagination'/>
                <b:includable id='postReactions'/>
                <b:includable id='postShareButtons'/>
                <b:includable id='postTimestamp'/>
                <b:includable id='postTitle' var='post'/>
                <b:includable id='previousPageLink'/>
                <b:includable id='sharingButton'/>
                <b:includable id='sharingButtonContent'/>
                <b:includable id='sharingButtons'/>
                <b:includable id='sharingButtonsMenu'/>
                <b:includable id='sharingPlatformIcon'/>
                <b:includable id='threadedCommentForm' var='post'/>
                <b:includable id='threadedCommentJs' var='post'/>
                <b:includable id='threadedComments' var='post'/>
                <b:includable id='tooltipCss'/>
              </b:widget>
            </b:section>
          </div>
        </div>

        <!-- Input Area -->
        <div class='input-area'>
          <div class='input-wrap'>
            <!-- Tools Dropdown (Desktop) -->
            <div class='tools-dropdown' id='toolsDropdown'>
              <div class='dropdown-section'>
                <div class='dropdown-label'>ðŸ“Ž Upload Media</div>
                <div class='dropdown-upload'>
                  <div class='upload-item' onclick='handleUpload(&quot;camera&quot;)'>
                    <i class='fas fa-camera'/>
                    <span>Kamera</span>
                  </div>
                  <div class='upload-item' onclick='handleUpload(&quot;gallery&quot;)'>
                    <i class='fas fa-image'/>
                    <span>Galeri</span>
                  </div>
                  <div class='upload-item' onclick='handleUpload(&quot;document&quot;)'>
                    <i class='fas fa-file-pdf'/>
                    <span>Dokumen</span>
                  </div>
                </div>
              </div>
              <div class='dropdown-section'>
                <div class='dropdown-label'>ðŸ§  Fitur Cerdas</div>
                <div class='dropdown-tools'>
                  <div class='tool-item' onclick='useTool(&quot;terjemah&quot;)'>
                    <i class='fas fa-language'/>
                    <span>Terjemah</span>
                  </div>
                  <div class='tool-item' onclick='useTool(&quot;irob&quot;)'>
                    <i class='fas fa-diagram-project'/>
                    <span>Analisis I&#39;rob</span>
                  </div>
                  <div class='tool-item' onclick='useTool(&quot;harakat&quot;)'>
                    <i class='fas fa-font'/>
                    <span>Beri Harakat</span>
                  </div>
                  <div class='tool-item' onclick='useTool(&quot;shorof&quot;)'>
                    <i class='fas fa-code-branch'/>
                    <span>Tasrif Shorof</span>
                  </div>
                  <div class='tool-item' onclick='useTool(&quot;menulis&quot;)'>
                    <i class='fas fa-pen-fancy'/>
                    <span>Menulis</span>
                  </div>
                  <div class='tool-item' onclick='useTool(&quot;administrasi&quot;)'>
                    <i class='fas fa-folder-open'/>
                    <span>Administrasi</span>
                  </div>
                </div>
              </div>
              <div class='dropdown-section'>
                <div class='dropdown-label'>ðŸ“š Template Cepat</div>
                <div class='dropdown-tools'>
                  <div class='tool-item' onclick='useTemplate(&quot;khutbah&quot;)'>
                    <i class='fas fa-mosque'/>
                    <span>Khutbah</span>
                  </div>
                  <div class='tool-item' onclick='useTemplate(&quot;ceramah&quot;)'>
                    <i class='fas fa-microphone-lines'/>
                    <span>Ceramah</span>
                  </div>
                  <div class='tool-item' onclick='useTemplate(&quot;proposal&quot;)'>
                    <i class='fas fa-file-lines'/>
                    <span>Proposal</span>
                  </div>
                  <div class='tool-item' onclick='useTemplate(&quot;surat&quot;)'>
                    <i class='fas fa-envelope'/>
                    <span>Surat Resmi</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Input Box -->
            <div class='input-box' id='inputBox'>
              <div class='input-left'>
                <button class='input-btn plus' id='plusBtn' onclick='toggleToolsResponsive()' title='Tools &amp; Upload'>
                  <i class='fas fa-plus-circle'/>
                </button>
              </div>
              
              <textarea autocomplete='off' class='input-field' id='userPrompt' placeholder='Tanyakan sesuatu tentang ilmu agama...' rows='1'/>
              
              <div class='input-right'>
                <button class='input-btn' id='emojiBtn' onclick='toggleEmojiPicker()' title='Emoji'>
                  <i class='fas fa-face-smile'/>
                </button>
                <button class='send-mic-btn mic' id='actionBtn' onclick='handleActionClick()'>
                  <i class='fas fa-microphone' id='actionIcon'/>
                </button>
              </div>
            </div>
            
            <div class='char-counter' id='charCounter'/>
            
            <p class='input-footer'>
              <i class='fas fa-shield-check' style='color: var(--accent-4);'/>
              Santrilogy AI bisa keliru. Selalu <a href='#' onclick='showDisclaimer()'>tashih ke guru</a>.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Tools Modal -->
    <div class='modal-overlay mobile-overlay' id='toolsOverlay' onclick='closeToolsModal()'/>
    <div class='mobile-modal' id='toolsModal'>
      <div class='modal-handle'/>
      <div class='modal-header'>
        <span class='modal-title'>ðŸ› &#65039; Alat Bantu</span>
        <button class='modal-close' onclick='closeToolsModal()'><i class='fas fa-times'/></button>
      </div>
      <div class='modal-body'>
        <!-- Fitur Cerdas -->
        <div class='modal-section-title'>ðŸ§  Fitur Cerdas</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='useTool(&quot;terjemah&quot;)'>
            <div class='tool-icon'><i class='fas fa-language'/></div>
            <div class='tool-label'>Terjemah Kitab</div>
            <div class='tool-desc'>Arab-Indonesia</div>
          </div>
          <div class='tool-card' onclick='useTool(&quot;irob&quot;)'>
            <div class='tool-icon' style='background: rgba(139,92,246,0.1); color: #8b5cf6;'><i class='fas fa-diagram-project'/></div>
            <div class='tool-label'>Analisis I&#39;rob</div>
            <div class='tool-desc'>Nahwu lengkap</div>
          </div>
          <div class='tool-card' onclick='useTool(&quot;harakat&quot;)'>
            <div class='tool-icon' style='background: rgba(6,182,212,0.1); color: #06b6d4;'><i class='fas fa-font'/></div>
            <div class='tool-label'>Beri Harakat</div>
            <div class='tool-desc'>Syakal otomatis</div>
          </div>
          <div class='tool-card' onclick='useTool(&quot;shorof&quot;)'>
            <div class='tool-icon' style='background: rgba(16,185,129,0.1); color: #10b981;'><i class='fas fa-code-branch'/></div>
            <div class='tool-label'>Tasrif Shorof</div>
            <div class='tool-desc'>14 wazan</div>
          </div>
          <div class='tool-card' onclick='useTool(&quot;menulis&quot;)'>
            <div class='tool-icon' style='background: rgba(245,158,11,0.1); color: #f59e0b;'><i class='fas fa-pen-fancy'/></div>
            <div class='tool-label'>Menulis</div>
            <div class='tool-desc'>Essay, artikel, dll</div>
          </div>
          <div class='tool-card' onclick='useTool(&quot;administrasi&quot;)'>
            <div class='tool-icon' style='background: rgba(239,68,68,0.1); color: #ef4444;'><i class='fas fa-folder-open'/></div>
            <div class='tool-label'>Administrasi</div>
            <div class='tool-desc'>Pendidikan</div>
          </div>
        </div>

        <!-- Upload Media -->
        <div class='modal-section-title' style='margin-top: 24px;'>ðŸ“Ž Upload Media</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='handleUpload(&quot;camera&quot;)'>
            <div class='tool-icon' style='background: rgba(236,72,153,0.1); color: #ec4899;'><i class='fas fa-camera'/></div>
            <div class='tool-label'>Kamera</div>
            <div class='tool-desc'>Scan langsung</div>
          </div>
          <div class='tool-card' onclick='handleUpload(&quot;gallery&quot;)'>
            <div class='tool-icon' style='background: rgba(34,197,94,0.1); color: #22c55e;'><i class='fas fa-image'/></div>
            <div class='tool-label'>Galeri</div>
            <div class='tool-desc'>Pilih gambar</div>
          </div>
          <div class='tool-card' onclick='handleUpload(&quot;document&quot;)'>
            <div class='tool-icon' style='background: rgba(59,130,246,0.1); color: #3b82f6;'><i class='fas fa-file-pdf'/></div>
            <div class='tool-label'>Dokumen</div>
            <div class='tool-desc'>PDF, Word</div>
          </div>
          <div class='tool-card' onclick='handleUpload(&quot;audio&quot;)'>
            <div class='tool-icon' style='background: rgba(168,85,247,0.1); color: #a855f7;'><i class='fas fa-microphone'/></div>
            <div class='tool-label'>Audio</div>
            <div class='tool-desc'>Voice note</div>
          </div>
        </div>

        <!-- Template Cepat -->
        <div class='modal-section-title' style='margin-top: 24px;'>ðŸ“ Template Cepat</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='useTemplate(&quot;khutbah&quot;)'>
            <div class='tool-icon' style='background: rgba(99,102,241,0.1); color: #6366f1;'><i class='fas fa-mosque'/></div>
            <div class='tool-label'>Khutbah Jumat</div>
          </div>
          <div class='tool-card' onclick='useTemplate(&quot;ceramah&quot;)'>
            <div class='tool-icon' style='background: rgba(139,92,246,0.1); color: #8b5cf6;'><i class='fas fa-microphone-lines'/></div>
            <div class='tool-label'>Teks Ceramah</div>
          </div>
          <div class='tool-card' onclick='useTemplate(&quot;proposal&quot;)'>
            <div class='tool-icon' style='background: rgba(6,182,212,0.1); color: #06b6d4;'><i class='fas fa-file-lines'/></div>
            <div class='tool-label'>Proposal Kegiatan</div>
          </div>
          <div class='tool-card' onclick='useTemplate(&quot;surat&quot;)'>
            <div class='tool-icon' style='background: rgba(16,185,129,0.1); color: #10b981;'><i class='fas fa-envelope'/></div>
            <div class='tool-label'>Surat Resmi</div>
          </div>
          <div class='tool-card' onclick='useTemplate(&quot;rpp&quot;)'>
            <div class='tool-icon' style='background: rgba(245,158,11,0.1); color: #f59e0b;'><i class='fas fa-chalkboard-teacher'/></div>
            <div class='tool-label'>RPP/Modul Ajar</div>
          </div>
          <div class='tool-card' onclick='useTemplate(&quot;soal&quot;)'>
            <div class='tool-icon' style='background: rgba(239,68,68,0.1); color: #ef4444;'><i class='fas fa-clipboard-question'/></div>
            <div class='tool-label'>Bank Soal</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Settings Modal -->
    <div class='modal-overlay mobile-overlay' id='settingsOverlay' onclick='closeSettingsModal()'/>
    <div class='mobile-modal' id='settingsModal'>
      <div class='modal-handle'/>
      <div class='modal-header'>
        <span class='modal-title'>&#9881;&#65039; Pengaturan</span>
        <button class='modal-close' onclick='closeSettingsModal()'><i class='fas fa-times'/></button>
      </div>
      <div class='modal-body'>
        <div class='mobile-setting-item' onclick='toggleDarkMode()'>
          <div class='mobile-setting-label'>
            <i class='fas fa-moon'/>
            <span>Mode Gelap</span>
          </div>
          <button class='toggle-switch' id='darkToggleMobile'/>
        </div>
        <div class='mobile-setting-item' onclick='toggleAutoSave()'>
          <div class='mobile-setting-label'>
            <i class='fas fa-cloud'/>
            <span>Simpan Otomatis</span>
          </div>
          <button class='toggle-switch on' id='autoSaveToggleMobile'/>
        </div>
        <div class='mobile-setting-item' onclick='toggleSound()'>
          <div class='mobile-setting-label'>
            <i class='fas fa-volume-high'/>
            <span>Efek Suara</span>
          </div>
          <button class='toggle-switch on' id='soundToggleMobile'/>
        </div>
        <div class='mobile-setting-item' onclick='toggleNotification()'>
          <div class='mobile-setting-label'>
            <i class='fas fa-bell'/>
            <span>Notifikasi</span>
          </div>
          <button class='toggle-switch on' id='notifToggleMobile'/>
        </div>
        
        <div class='modal-section-title' style='margin-top: 20px;'>ðŸŽ¨ Tampilan</div>
        <div class='mobile-setting-item'>
          <div class='mobile-setting-label'>
            <i class='fas fa-palette'/>
            <span>Tema Warna</span>
          </div>
          <div class='color-pills'>
            <button class='color-pill c-indigo active' data-color='#6366f1' onclick='applyThemeColor(this)'/>
            <button class='color-pill c-blue' data-color='#3b82f6' onclick='applyThemeColor(this)'/>
            <button class='color-pill c-green' data-color='#10b981' onclick='applyThemeColor(this)'/>
            <button class='color-pill c-purple' data-color='#8b5cf6' onclick='applyThemeColor(this)'/>
          </div>
        </div>

        <div class='modal-section-title' style='margin-top: 20px;'>ðŸ“Š Data</div>
        <div class='mobile-setting-item' onclick='exportChats()' style='cursor: pointer;'>
          <div class='mobile-setting-label'>
            <i class='fas fa-download'/>
            <span>Ekspor Riwayat Chat</span>
          </div>
          <i class='fas fa-chevron-right' style='color: var(--text-muted);'/>
        </div>
        <div class='mobile-setting-item' onclick='clearAllChats()' style='cursor: pointer;'>
          <div class='mobile-setting-label'>
            <i class='fas fa-trash' style='color: var(--accent-6);'/>
            <span style='color: var(--accent-6);'>Hapus Semua Chat</span>
          </div>
          <i class='fas fa-chevron-right' style='color: var(--accent-6);'/>
        </div>
      </div>
    </div>

    <!-- Writing Assistant Modal -->
    <div class='modal-overlay' id='writingOverlay' onclick='closeWritingModal()'/>
    <div class='mobile-modal' id='writingModal'>
      <div class='modal-handle'/>
      <div class='modal-header'>
        <span class='modal-title'>&#9997;&#65039; Asisten Menulis</span>
        <button class='modal-close' onclick='closeWritingModal()'><i class='fas fa-times'/></button>
      </div>
      <div class='modal-body'>
        <div class='modal-section-title'>Pilih Jenis Tulisan</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='startWriting(&quot;essay&quot;)'>
            <div class='tool-icon'><i class='fas fa-file-alt'/></div>
            <div class='tool-label'>Essay</div>
            <div class='tool-desc'>Karangan ilmiah</div>
          </div>
          <div class='tool-card' onclick='startWriting(&quot;artikel&quot;)'>
            <div class='tool-icon' style='background: rgba(139,92,246,0.1); color: #8b5cf6;'><i class='fas fa-newspaper'/></div>
            <div class='tool-label'>Artikel</div>
            <div class='tool-desc'>Blog &amp; media</div>
          </div>
          <div class='tool-card' onclick='startWriting(&quot;cerpen&quot;)'>
            <div class='tool-icon' style='background: rgba(236,72,153,0.1); color: #ec4899;'><i class='fas fa-book-open-reader'/></div>
            <div class='tool-label'>Cerpen</div>
            <div class='tool-desc'>Cerita pendek</div>
          </div>
          <div class='tool-card' onclick='startWriting(&quot;puisi&quot;)'>
            <div class='tool-icon' style='background: rgba(245,158,11,0.1); color: #f59e0b;'><i class='fas fa-feather'/></div>
            <div class='tool-label'>Puisi</div>
            <div class='tool-desc'>Syair &amp; sajak</div>
          </div>
          <div class='tool-card' onclick='startWriting(&quot;resume&quot;)'>
            <div class='tool-icon' style='background: rgba(16,185,129,0.1); color: #10b981;'><i class='fas fa-compress'/></div>
            <div class='tool-label'>Ringkasan</div>
            <div class='tool-desc'>Summary teks</div>
          </div>
          <div class='tool-card' onclick='startWriting(&quot;parafrase&quot;)'>
            <div class='tool-icon' style='background: rgba(6,182,212,0.1); color: #06b6d4;'><i class='fas fa-arrows-rotate'/></div>
            <div class='tool-label'>Parafrase</div>
            <div class='tool-desc'>Ubah kalimat</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Administrasi Modal -->
    <div class='modal-overlay' id='adminOverlay' onclick='closeAdminModal()'/>
    <div class='mobile-modal' id='adminModal'>
      <div class='modal-handle'/>
      <div class='modal-header'>
        <span class='modal-title'>ðŸ“ Administrasi Pendidikan</span>
        <button class='modal-close' onclick='closeAdminModal()'><i class='fas fa-times'/></button>
      </div>
      <div class='modal-body'>
        <div class='modal-section-title'>Dokumen Pembelajaran</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='generateAdmin(&quot;rpp&quot;)'>
            <div class='tool-icon'><i class='fas fa-chalkboard-teacher'/></div>
            <div class='tool-label'>RPP</div>
            <div class='tool-desc'>Rencana Pembelajaran</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;modul&quot;)'>
            <div class='tool-icon' style='background: rgba(139,92,246,0.1); color: #8b5cf6;'><i class='fas fa-book'/></div>
            <div class='tool-label'>Modul Ajar</div>
            <div class='tool-desc'>Kurikulum Merdeka</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;silabus&quot;)'>
            <div class='tool-icon' style='background: rgba(6,182,212,0.1); color: #06b6d4;'><i class='fas fa-list-check'/></div>
            <div class='tool-label'>Silabus</div>
            <div class='tool-desc'>Outline materi</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;prota&quot;)'>
            <div class='tool-icon' style='background: rgba(16,185,129,0.1); color: #10b981;'><i class='fas fa-calendar-days'/></div>
            <div class='tool-label'>Prota/Promes</div>
            <div class='tool-desc'>Program tahunan</div>
          </div>
        </div>

        <div class='modal-section-title' style='margin-top: 20px;'>Penilaian &amp; Evaluasi</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='generateAdmin(&quot;soal&quot;)'>
            <div class='tool-icon' style='background: rgba(245,158,11,0.1); color: #f59e0b;'><i class='fas fa-clipboard-question'/></div>
            <div class='tool-label'>Bank Soal</div>
            <div class='tool-desc'>PG, Essay, dll</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;rubrik&quot;)'>
            <div class='tool-icon' style='background: rgba(239,68,68,0.1); color: #ef4444;'><i class='fas fa-table'/></div>
            <div class='tool-label'>Rubrik Penilaian</div>
            <div class='tool-desc'>Kriteria evaluasi</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;rapor&quot;)'>
            <div class='tool-icon' style='background: rgba(236,72,153,0.1); color: #ec4899;'><i class='fas fa-file-invoice'/></div>
            <div class='tool-label'>Narasi Rapor</div>
            <div class='tool-desc'>Deskripsi siswa</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;remedial&quot;)'>
            <div class='tool-icon' style='background: rgba(168,85,247,0.1); color: #a855f7;'><i class='fas fa-rotate-left'/></div>
            <div class='tool-label'>Program Remedial</div>
            <div class='tool-desc'>Perbaikan nilai</div>
          </div>
        </div>

        <div class='modal-section-title' style='margin-top: 20px;'>Surat &amp; Dokumen</div>
        <div class='tools-grid'>
          <div class='tool-card' onclick='generateAdmin(&quot;surat_tugas&quot;)'>
            <div class='tool-icon'><i class='fas fa-envelope-open-text'/></div>
            <div class='tool-label'>Surat Tugas</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;sk&quot;)'>
            <div class='tool-icon' style='background: rgba(139,92,246,0.1); color: #8b5cf6;'><i class='fas fa-stamp'/></div>
            <div class='tool-label'>SK Kepala</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;undangan&quot;)'>
            <div class='tool-icon' style='background: rgba(6,182,212,0.1); color: #06b6d4;'><i class='fas fa-envelope'/></div>
            <div class='tool-label'>Undangan</div>
          </div>
          <div class='tool-card' onclick='generateAdmin(&quot;notulen&quot;)'>
            <div class='tool-icon' style='background: rgba(16,185,129,0.1); color: #10b981;'><i class='fas fa-clipboard'/></div>
            <div class='tool-label'>Notulen Rapat</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden Inputs -->
    <input accept='image/*' capture='environment' id='cameraInput' onchange='handleFileSelect(event, &quot;camera&quot;)' style='display: none;' type='file'/>
    <input accept='image/*' id='galleryInput' multiple='multiple' onchange='handleFileSelect(event, &quot;gallery&quot;)' style='display: none;' type='file'/>
    <input accept='.pdf,.doc,.docx,.txt' id='documentInput' onchange='handleFileSelect(event, &quot;document&quot;)' style='display: none;' type='file'/>
    <input accept='audio/*' id='audioInput' onchange='handleFileSelect(event, &quot;audio&quot;)' style='display: none;' type='file'/>
    <input id='customColorPicker' onchange='applyCustomColor(this.value)' style='display: none;' type='color' value='#6366f1'/>

    <!-- Highlight.js -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js'/>
    
    <!-- Main Script -->
    <script>
    //<![CDATA[
    
    /* ============================================
       SANTRILOGY AI - ULTRA PREMIUM JAVASCRIPT
       Version 3.0 - Complete Feature Set
       ============================================ */

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        // Ganti dengan URL Cloudflare Worker yang baru Anda buat
        API_URL: "https://santrilogy-proxy.santrilogyapp.workers.dev/", 
        
        // KOSONGKAN API KEY! Sekarang sudah aman di server.
        API_KEY: "", 
        
        MAX_CHARS: 4000,
        TYPING_SPEED: 20,
        AUTO_SAVE: true,
        SOUND_ENABLED: true,
        VERSION: "3.1.0" // Versi naik
    };

    // ==================== DATABASE MANAGER (INDEXED DB) ====================
    const DB = {
        storeName: 'santrilogy_store',

        // Simpan Chat Baru ke History
        async saveChat(chatItem) {
            try {
                if (typeof idbKeyval === 'undefined') return;
                const history = (await idbKeyval.get('chat_history')) || [];
                history.unshift(chatItem);

                // Limit 100 percakapan terakhir agar browser tetap ringan
                if (history.length > 100) history.pop();

                await idbKeyval.set('chat_history', history);
                this.updateIndicator(history.length);
            } catch (e) { console.error('DB Save Error:', e); }
        },

        // Ambil Semua History
        async getHistory() {
            try {
                if (typeof idbKeyval === 'undefined') return [];
                return (await idbKeyval.get('chat_history')) || [];
            } catch (e) { return []; }
        },

        // Update UI Indikator Penyimpanan
        updateIndicator(count) {
            const max = 100;
            const percentage = Math.min((count / max) * 100, 100);
            const valEl = document.getElementById('storageValue');
            const fillEl = document.getElementById('storageFill');
            if (valEl) valEl.textContent = `${count}/${max} chat`;
            if (fillEl) fillEl.style.width = `${percentage}%`;
        },

        // Bersihkan Database
        async clear() {
            if (typeof idbKeyval !== 'undefined') await idbKeyval.clear();
            this.updateIndicator(0);
        }
    };

    // ==================== STATE MANAGEMENT ====================
    const AppState = {
        currentModel: 'pro',
        isDarkMode: false,
        isListening: false,
        isSending: false,
        chatHistory: [],
        settings: {
            autoSave: true,
            soundEnabled: true,
            notifications: true,
            fontSize: 'medium',
            themeColor: '#6366f1'
        }
    };

    let recognition = null;
    let currentAudio = null;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log(`ðŸš€ Santrilogy AI v${CONFIG.VERSION} initialized`);
        
        // Load saved settings
        loadSettings();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize speech recognition
        initSpeechRecognition();
        
        // Initialize highlight.js
        if (typeof hljs !== 'undefined') {
            hljs.highlightAll();
        }
        
        // Check for PWA install prompt
        setupPWA();
        
        // Show welcome toast
        setTimeout(() => {
            showToast('success', 'Selamat Datang!', 'Santrilogy AI siap membantu kajian Anda');
        }, 1000);
    });

    function setupEventListeners() {
        const userPrompt = document.getElementById('userPrompt');
        
        if (userPrompt) {
            // Auto-resize textarea
            userPrompt.addEventListener('input', handleInputChange);
            
            // Enter to send (Shift+Enter for new line)
            userPrompt.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim().length > 0) {
                        handleActionClick();
                    }
                }
            });

            // Focus effect
            userPrompt.addEventListener('focus', function() {
                document.getElementById('inputBox').classList.add('focused');
            });
            
            userPrompt.addEventListener('blur', function() {
                document.getElementById('inputBox').classList.remove('focused');
            });
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.model-selector') && !e.target.closest('.model-dropdown')) {
                closeModelDropdown();
            }
            if (!e.target.closest('.icon-btn') && !e.target.closest('.more-dropdown')) {
                closeMoreDropdown();
            }
            if (!e.target.closest('.input-btn.plus') && !e.target.closest('.tools-dropdown')) {
                closeToolsDropdown();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K = New chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                startNewChat();
            }
            // Ctrl/Cmd + / = Toggle sidebar
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                toggleSidebar();
            }
            // Escape = Close modals
            if (e.key === 'Escape') {
                closeAllModals();
            }
        });

        // Scroll to bottom on new message
        const chatArea = document.getElementById('chatArea');
        if (chatArea) {
            const observer = new MutationObserver(function(mutations) {
                chatArea.scrollTo({
                    top: chatArea.scrollHeight,
                    behavior: 'smooth'
                });
            });
            observer.observe(document.getElementById('chatContainer'), { 
                childList: true, 
                subtree: true 
            });
        }
    }

    // ==================== INPUT HANDLING ====================
    function handleInputChange() {
        const input = document.getElementById('userPrompt');
        const btn = document.getElementById('actionBtn');
        const icon = document.getElementById('actionIcon');
        const counter = document.getElementById('charCounter');
        
        // Auto-resize
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 150) + 'px';
        
        const charCount = input.value.length;
        
        // Update character counter
        if (charCount > 0) {
            counter.textContent = `${charCount}/${CONFIG.MAX_CHARS}`;
            counter.style.display = 'block';
            
            if (charCount > CONFIG.MAX_CHARS * 0.9) {
                counter.className = 'char-counter danger';
            } else if (charCount > CONFIG.MAX_CHARS * 0.7) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter';
            }
        } else {
            counter.style.display = 'none';
        }
        
        // Toggle send/mic button
        if (input.value.trim().length > 0) {
            btn.className = 'send-mic-btn send';
            icon.className = 'fas fa-paper-plane';
        } else {
            btn.className = 'send-mic-btn mic';
            icon.className = 'fas fa-microphone';
        }
    }

    function handleActionClick() {
        const input = document.getElementById('userPrompt');
        if (input.value.trim().length > 0) {
            sendMessage();
        } else {
            toggleVoiceInput();
        }
    }

    function getChatContext() {
        const context = [];
        const chatContainer = document.getElementById('chatContainer');
        // Ambil elemen chat (abaikan loading/hidden)
        const bubbles = chatContainer.querySelectorAll('.post-outer');

        // Ambil maksimal 6 pesan terakhir (3 pasang tanya-jawab)
        const startIndex = Math.max(0, bubbles.length - 6);

        for (let i = startIndex; i < bubbles.length; i++) {
            const bubble = bubbles[i];
            const isUser = bubble.querySelector('.msg-avatar.user');
            const body = bubble.querySelector('.post-body');

            if (body) {
                context.push({
                    role: isUser ? 'user' : 'assistant',
                    content: body.innerText.trim() // Gunakan innerText untuk mengambil teks bersih
                });
            }
        }
        return context;
    }

    // ==================== MESSAGE HANDLING ====================
    async function sendMessage() {
        const input = document.getElementById('userPrompt');
        const text = input.value.trim();
        
        if (!text || AppState.isSending) return;
        
        // Check character limit
        if (text.length > CONFIG.MAX_CHARS) {
            showToast('warning', 'Pesan Terlalu Panjang', `Maksimal ${CONFIG.MAX_CHARS} karakter`);
            return;
        }
        
        AppState.isSending = true;
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        handleInputChange();
        
        // Hide welcome screen
        const welcome = document.getElementById('welcomeScreen');
        if (welcome) welcome.style.display = 'none';
        
        // Add user message
        addMessageBubble(text, 'user');
        
        // Play sound
        playSound('send');
        
        // Add loading indicator
        const loadingId = addLoadingIndicator();

        // [BARU] Ambil Konteks Percakapan
        const recentMessages = getChatContext();

        // [BARU] Tambahkan pesan user saat ini ke antrian
        const messagesPayload = [
            ...recentMessages,
            { role: "user", content: text }
        ];

        try {
            const response = await callAPI(messagesPayload);
            removeLoadingIndicator(loadingId);

            if (response) {
                addMessageBubble(response, 'ai');
                playSound('receive');

                // [UBAH INI] Simpan ke IndexedDB
                if (AppState.settings.autoSave) {
                    DB.saveChat({
                        id: Date.now(),
                        question: text.substring(0, 100),
                        answer: response.substring(0, 200),
                        timestamp: new Date().toISOString()
                    });
                }
            }
        } catch (error) {
            removeLoadingIndicator(loadingId);
            addMessageBubble(`Maaf, terjadi kesalahan: ${error.message}. Silakan coba lagi.`, 'ai', true);
            showToast('error', 'Error', error.message);
        }

        AppState.isSending = false;
    }

    async function callAPI(messagesPayload) {
        // Gunakan URL Proxy baru Anda dari CONFIG
        const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // HAPUS baris 'Authorization': ... karena sudah tidak perlu.
                // Proxy Cloudflare yang akan menyuntikkan kuncinya nanti.
            },
            body: JSON.stringify({
                messages: messagesPayload, // [UBAH INI] Kirim array messages, bukan prompt string
                model: AppState.currentModel
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'API Error');
        }

        const data = await response.json();
        return data.answer || data.response || data.message;
    }

    // ==================== UI COMPONENTS ====================
    function addMessageBubble(content, type, isError = false) {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'post-outer';
        
        const time = new Date().toLocaleTimeString('id-ID', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const formattedContent = type === 'ai' ? parseMarkdown(content) : escapeHtml(content);
        
        messageDiv.innerHTML = `
            <div class="msg">
                <div class="msg-avatar ${type}">
                    ${type === 'ai' ? `
                        <div class="atom-mini">
                            <div class="atom-nucleus"></div>
                            <div class="atom-orbit orbit-1"></div>
                        </div>
                    ` : 'A'}
                </div>
                <div class="msg-body">
                    <div class="msg-header">
                        <span class="msg-name">${type === 'ai' ? 'Santrilogy AI' : 'Anda'}</span>
                        <span class="msg-time">${time}</span>
                        ${type === 'ai' ? '<span class="msg-badge">PRO</span>' : ''}
                    </div>
                    <div class="post-body ${isError ? 'error-message' : ''}">${formattedContent}</div>
                    ${type === 'ai' ? `
                        <div class="msg-actions">
                            <button class="msg-action-btn" onclick="copyMessage(this)" title="Salin">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="msg-action-btn" onclick="likeMessage(this)" title="Suka">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="msg-action-btn" onclick="speakMessage(this)" title="Baca">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <button class="msg-action-btn" onclick="shareMessage(this)" title="Bagikan">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="msg-action-btn" onclick="regenerateMessage(this)" title="Generate Ulang">
                                <i class="fas fa-rotate"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(messageDiv);
        
        // Highlight code blocks
        messageDiv.querySelectorAll('pre code').forEach((block) => {
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(block);
            }
        });
        
        // Scroll to new message
        const chatArea = document.getElementById('chatArea');
        chatArea.scrollTo({
            top: chatArea.scrollHeight,
            behavior: 'smooth'
        });
        
        return messageDiv;
    }

    function addLoadingIndicator() {
        const container = document.getElementById('chatContainer');
        const id = 'loading-' + Date.now();
        
        const loadingDiv = document.createElement('div');
        loadingDiv.id = id;
        loadingDiv.className = 'post-outer';
        loadingDiv.innerHTML = `
            <div class="msg">
                <div class="msg-avatar ai">
                    <div class="atom-mini">
                        <div class="atom-nucleus"></div>
                        <div class="atom-orbit orbit-1"></div>
                    </div>
                </div>
                <div class="msg-body">
                    <div class="msg-header">
                        <span class="msg-name">Santrilogy AI</span>
                        <span class="msg-time">Mengetik...</span>
                    </div>
                    <div class="post-body">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(loadingDiv);
        return id;
    }

    function removeLoadingIndicator(id) {
        const element = document.getElementById(id);
        if (element) {
            element.remove();
        }
    }

    // ==================== MARKDOWN PARSER (PROFESSIONAL UPGRADE) ====================
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            highlight: function(code, lang) {
                if (typeof hljs !== 'undefined') {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
                return code;
            }
        });
    }

    function parseMarkdown(text) {
        if (!text) return '';

        if (typeof marked === 'undefined') {
            console.warn('Marked.js belum dimuat.');
            return `<p>${escapeHtml(text)}</p>`;
        }

        try {
            let html = marked.parse(text);

            // Post-Processing: Deteksi Teks Arab (RTL & Font Amiri)
            const arabicRegex = /([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]+)/g;
            html = html.replace(arabicRegex, '<span class="arabic">$1</span>');

            // Post-Processing: Table Wrapper untuk Responsivitas Mobile
            html = html.replace(/<table>/g, '<div class="table-responsive"><table>')
                       .replace(/<\/table>/g, '</table></div>');

            return html;
        } catch (e) {
            console.error("Markdown parsing error:", e);
            return `<p>${escapeHtml(text)}</p>`;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== SIDEBAR FUNCTIONS ====================
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const isOpen = !sidebar.classList.contains('collapsed');
        
        if (isOpen) {
            sidebar.classList.add('collapsed');
            overlay.classList.remove('active');
        } else {
            sidebar.classList.remove('collapsed');
            overlay.classList.add('active');
        }
    };

    window.closeSidebar = function() {
        document.getElementById('sidebar').classList.add('collapsed');
        document.getElementById('overlay').classList.remove('active');
    };

    // ==================== SETTINGS FUNCTIONS ====================
    window.toggleSettings = function() {
        const dropdown = document.getElementById('settingsDropdown');
        const chevron = document.getElementById('profileChevron');
        
        dropdown.classList.toggle('show');
        chevron.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : '';
    };

    window.closeSettingsDropdown = function() {
        document.getElementById('settingsDropdown').classList.remove('show');
        document.getElementById('profileChevron').style.transform = '';
    };

    window.toggleDarkMode = function() {
        AppState.isDarkMode = !AppState.isDarkMode;
        document.documentElement.setAttribute('data-theme', AppState.isDarkMode ? 'dark' : 'light');
        
        // Update toggles
        const toggles = ['darkToggleDesktop', 'darkToggleMobile'];
        toggles.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('on', AppState.isDarkMode);
        });
        
        saveSettings();
        showToast('info', 'Tema Diubah', AppState.isDarkMode ? 'Mode gelap aktif' : 'Mode terang aktif');
    };

    window.toggleAutoSave = function() {
        AppState.settings.autoSave = !AppState.settings.autoSave;
        
        const toggles = ['autoSaveToggle', 'autoSaveToggleMobile'];
        toggles.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('on', AppState.settings.autoSave);
        });
        
        saveSettings();
    };

    window.toggleSound = function() {
        AppState.settings.soundEnabled = !AppState.settings.soundEnabled;
        
        const toggles = ['soundToggle', 'soundToggleMobile'];
        toggles.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('on', AppState.settings.soundEnabled);
        });
        
        saveSettings();
    };

    window.toggleNotification = function() {
        AppState.settings.notifications = !AppState.settings.notifications;
        
        const el = document.getElementById('notifToggleMobile');
        if (el) el.classList.toggle('on', AppState.settings.notifications);
        
        saveSettings();
    };

    window.applyThemeColor = function(element) {
        const color = element.dataset.color;
        if (color) {
            document.documentElement.style.setProperty('--accent', color);
            AppState.settings.themeColor = color;
            
            // Update active state
            document.querySelectorAll('.color-pill').forEach(p => p.classList.remove('active'));
            element.classList.add('active');
            
            saveSettings();
        }
    };

    window.openColorPicker = function() {
        document.getElementById('customColorPicker').click();
    };

    window.applyCustomColor = function(color) {
        document.documentElement.style.setProperty('--accent', color);
        AppState.settings.themeColor = color;
        saveSettings();
    };

    window.setFontSize = function(size) {
        const sizes = {
            'small': '14px',
            'medium': '15px',
            'large': '17px'
        };
        
        document.documentElement.style.setProperty('--font-base', sizes[size]);
        AppState.settings.fontSize = size;
        saveSettings();
    };

    // ==================== MODEL SELECTOR ====================
    window.toggleModelDropdown = function() {
        const dropdown = document.getElementById('modelDropdown');
        const chevron = document.getElementById('modelChevron');
        
        dropdown.classList.toggle('show');
        chevron.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : '';
    };

    window.closeModelDropdown = function() {
        const dropdown = document.getElementById('modelDropdown');
        const chevron = document.getElementById('modelChevron');
        
        if (dropdown) dropdown.classList.remove('show');
        if (chevron) chevron.style.transform = '';
    };

    window.selectModel = function(model, element) {
        AppState.currentModel = model;
        
        const models = {
            'pro': 'Santrilogy Pro',
            'turbo': 'Santrilogy Turbo',
            'scholar': 'Santrilogy Scholar'
        };
        
        document.getElementById('currentModel').textContent = models[model];
        
        // Update active state
        document.querySelectorAll('.model-option').forEach(opt => opt.classList.remove('active'));
        element.classList.add('active');
        
        closeModelDropdown();
        showToast('success', 'Model Diubah', `Menggunakan ${models[model]}`);
    };

    // ==================== MORE DROPDOWN ====================
    window.toggleMoreDropdown = function() {
        document.getElementById('moreDropdown').classList.toggle('show');
    };

    window.closeMoreDropdown = function() {
        const dropdown = document.getElementById('moreDropdown');
        if (dropdown) dropdown.classList.remove('show');
    };

    // ==================== TOOLS FUNCTIONS ====================
    window.toggleToolsResponsive = function() {
        if (window.innerWidth <= 768) {
            openToolsModal();
        } else {
            document.getElementById('toolsDropdown').classList.toggle('show');
        }
    };

    window.closeToolsDropdown = function() {
        const dropdown = document.getElementById('toolsDropdown');
        if (dropdown) dropdown.classList.remove('show');
    };

    window.openToolsModal = function() {
        document.getElementById('toolsModal').classList.add('show');
        document.getElementById('toolsOverlay').classList.add('show');
    };

    window.closeToolsModal = function() {
        document.getElementById('toolsModal').classList.remove('show');
        document.getElementById('toolsOverlay').classList.remove('show');
    };

    window.useTool = function(tool) {
        closeToolsModal();
        closeToolsDropdown();
        
        const prompts = {
            'terjemah': 'Tolong terjemahkan teks Arab berikut ke Bahasa Indonesia dengan penjelasan maknanya:\n\n',
            'irob': 'Berikan analisis i\'rob lengkap untuk kalimat Arab berikut:\n\n',
            'harakat': 'Berikan harakat/syakal lengkap untuk teks Arab gundul berikut:\n\n',
            'shorof': 'Jelaskan tasrif lughowi dan istilahi dari kata berikut beserta wazan-nya:\n\n',
            'menulis': '',
            'administrasi': ''
        };
        
        if (tool === 'menulis') {
            openWritingModal();
            return;
        }
        
        if (tool === 'administrasi') {
            openAdminModal();
            return;
        }
        
        const input = document.getElementById('userPrompt');
        input.value = prompts[tool] || '';
        input.focus();
        handleInputChange();
        
        showToast('info', 'Alat Aktif', `Mode ${tool} aktif. Silakan masukkan teks.`);
    };

    window.useTemplate = function(template) {
        closeToolsModal();
        closeToolsDropdown();
        
        const templates = {
            'khutbah': 'Buatkan teks khutbah Jumat tentang tema berikut dengan mukadimah lengkap:\n\nTema: ',
            'ceramah': 'Buatkan teks ceramah/kultum singkat tentang:\n\nTema: ',
            'proposal': 'Buatkan proposal kegiatan dengan format lengkap untuk:\n\nNama Kegiatan: ',
            'surat': 'Buatkan surat resmi dengan format yang benar untuk:\n\nPerihal: ',
            'rpp': 'Buatkan RPP/Modul Ajar Kurikulum Merdeka untuk:\n\nMata Pelajaran: \nKelas: \nMateri: ',
            'soal': 'Buatkan 10 soal dengan kunci jawaban untuk:\n\nMata Pelajaran: \nMateri: \nJenis Soal: '
        };
        
        const input = document.getElementById('userPrompt');
        input.value = templates[template] || '';
        input.focus();
        handleInputChange();
    };

    // ==================== WRITING MODAL ====================
    window.openWritingModal = function() {
        document.getElementById('writingModal').classList.add('show');
        document.getElementById('writingOverlay').classList.add('show');
    };

    window.closeWritingModal = function() {
        document.getElementById('writingModal').classList.remove('show');
        document.getElementById('writingOverlay').classList.remove('show');
    };

    window.startWriting = function(type) {
        closeWritingModal();
        
        const prompts = {
            'essay': 'Bantu saya menulis essay ilmiah tentang:\n\nTema: \nJumlah Paragraf: ',
            'artikel': 'Buatkan artikel blog yang menarik tentang:\n\nJudul: \nPanjang: ',
            'cerpen': 'Buatkan cerpen dengan detail berikut:\n\nTema: \nTokoh: \nLatar: ',
            'puisi': 'Buatkan puisi/syair tentang:\n\nTema: \nGaya: ',
            'resume': 'Buatkan ringkasan/summary dari teks berikut:\n\n',
            'parafrase': 'Parafrase teks berikut dengan bahasa yang berbeda tanpa mengubah makna:\n\n'
        };
        
        const input = document.getElementById('userPrompt');
        input.value = prompts[type] || '';
        input.focus();
        handleInputChange();
        
        showToast('info', 'Asisten Menulis', `Mode ${type} aktif. Lengkapi detail lalu kirim.`);
    };

    // ==================== ADMIN MODAL ====================
    window.openAdminModal = function() {
        document.getElementById('adminModal').classList.add('show');
        document.getElementById('adminOverlay').classList.add('show');
    };

    window.closeAdminModal = function() {
        document.getElementById('adminModal').classList.remove('show');
        document.getElementById('adminOverlay').classList.remove('show');
    };

    window.generateAdmin = function(type) {
        closeAdminModal();
        
        const prompts = {
            'rpp': 'Buatkan RPP lengkap dengan format Kurikulum Merdeka:\n\nSatuan Pendidikan: \nMata Pelajaran: \nKelas/Semester: \nMateri Pokok: \nAlokasi Waktu: ',
            'modul': 'Buatkan Modul Ajar Kurikulum Merdeka lengkap:\n\nMata Pelajaran: \nKelas: \nTema/Topik: \nTujuan Pembelajaran: ',
            'silabus': 'Buatkan silabus pembelajaran lengkap:\n\nMata Pelajaran: \nKelas: \nSemester: ',
            'prota': 'Buatkan Program Tahunan (Prota) untuk:\n\nMata Pelajaran: \nKelas: \nTahun Ajaran: ',
            'soal': 'Buatkan bank soal lengkap dengan kunci jawaban:\n\nMata Pelajaran: \nKelas: \nMateri: \nJumlah Soal PG: \nJumlah Soal Essay: ',
            'rubrik': 'Buatkan rubrik penilaian untuk:\n\nJenis Tugas: \nMata Pelajaran: \nKriteria yang dinilai: ',
            'rapor': 'Buatkan narasi deskripsi rapor untuk siswa dengan karakteristik:\n\nNama: \nKelas: \nKelebihan: \nHal yang perlu ditingkatkan: ',
            'remedial': 'Buatkan program remedial untuk:\n\nMata Pelajaran: \nKelas: \nKD yang belum tuntas: ',
            'surat_tugas': 'Buatkan surat tugas resmi:\n\nDari: \nKepada: \nPerihal: \nTanggal Kegiatan: ',
            'sk': 'Buatkan SK (Surat Keputusan) Kepala Sekolah:\n\nNomor: \nTentang: \nPertimbangan: ',
            'undangan': 'Buatkan surat undangan resmi:\n\nAcara: \nHari/Tanggal: \nTempat: \nWaktu: ',
            'notulen': 'Buatkan format notulen rapat:\n\nNama Rapat: \nHari/Tanggal: \nTempat: \nAgenda: '
        };
        
        const input = document.getElementById('userPrompt');
        input.value = prompts[type] || '';
        input.focus();
        handleInputChange();
        
        showToast('info', 'Administrasi', `Template ${type} siap. Lengkapi data lalu kirim.`);
    };

    // ==================== MOBILE SETTINGS MODAL ====================
    window.openMobileSettings = function() {
        closeSidebar();
        document.getElementById('settingsModal').classList.add('show');
        document.getElementById('settingsOverlay').classList.add('show');
    };

    window.closeSettingsModal = function() {
        document.getElementById('settingsModal').classList.remove('show');
        document.getElementById('settingsOverlay').classList.remove('show');
    };

    // ==================== FILE UPLOAD ====================
    window.handleUpload = function(type) {
        closeToolsModal();
        closeToolsDropdown();
        
        const inputs = {
            'camera': 'cameraInput',
            'gallery': 'galleryInput',
            'document': 'documentInput',
            'audio': 'audioInput'
        };
        
        const inputEl = document.getElementById(inputs[type]);
        if (inputEl) {
            inputEl.click();
        }
    };

    window.handleFileSelect = function(event, type) {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        
        const file = files[0];
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (file.size > maxSize) {
            showToast('error', 'File Terlalu Besar', 'Maksimal ukuran file adalah 10MB');
            return;
        }
        
        // Show preview/processing toast
        showToast('info', 'Memproses File', `${file.name} sedang diproses...`);
        
        // For images, we can add OCR or image description
        if (type === 'camera' || type === 'gallery') {
            processImage(file);
        } else if (type === 'document') {
            processDocument(file);
        } else if (type === 'audio') {
            processAudio(file);
        }
        
        // Reset input
        event.target.value = '';
    };

    function processImage(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // For now, just add a prompt about the image
            const input = document.getElementById('userPrompt');
            input.value = `[Gambar telah diupload: ${file.name}]\n\nAnalisis gambar kitab ini dan berikan:\n1. Teks Arab yang terlihat\n2. Terjemahan\n3. Penjelasan singkat`;
            input.focus();
            handleInputChange();
            
            showToast('success', 'Gambar Siap', 'Gambar berhasil diupload. Kirim untuk analisis.');
        };
        reader.readAsDataURL(file);
    }

    function processDocument(file) {
        showToast('info', 'Fitur Dalam Pengembangan', 'Upload dokumen akan segera tersedia');
    }

    function processAudio(file) {
        showToast('info', 'Fitur Dalam Pengembangan', 'Upload audio akan segera tersedia');
    }

    // ==================== VOICE INPUT ====================
    function initSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'id-ID';
            
            recognition.onstart = function() {
                AppState.isListening = true;
                const btn = document.getElementById('actionBtn');
                btn.classList.add('recording');
                document.getElementById('actionIcon').className = 'fas fa-stop';
                showToast('info', 'Mendengarkan...', 'Silakan bicara');
            };
            
            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('userPrompt').value = transcript;
                handleInputChange();
            };
            
            recognition.onend = function() {
                AppState.isListening = false;
                const btn = document.getElementById('actionBtn');
                btn.classList.remove('recording');
                
                const input = document.getElementById('userPrompt');
                if (input.value.trim().length > 0) {
                    document.getElementById('actionIcon').className = 'fas fa-paper-plane';
                    btn.className = 'send-mic-btn send';
                } else {
                    document.getElementById('actionIcon').className = 'fas fa-microphone';
                    btn.className = 'send-mic-btn mic';
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                AppState.isListening = false;
                showToast('error', 'Error', 'Gagal mengenali suara. Coba lagi.');
            };
        }
    }

    function toggleVoiceInput() {
        if (!recognition) {
            showToast('warning', 'Tidak Didukung', 'Browser Anda tidak mendukung input suara');
            return;
        }
        
        if (AppState.isListening) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch (e) {
                console.error('Recognition error:', e);
            }
        }
    }

    window.startVoiceChat = function() {
        toggleVoiceInput();
    };

    window.uploadImage = function() {
        handleUpload('camera');
    };

    // ==================== TEXT TO SPEECH ====================
    window.speakMessage = function(btn) {
        const messageBody = btn.closest('.msg-body').querySelector('.post-body');
        const text = messageBody.textContent || messageBody.innerText;
        
        if ('speechSynthesis' in window) {
            // Stop any current speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            utterance.onstart = function() {
                btn.innerHTML = '<i class="fas fa-volume-xmark"></i>';
                btn.classList.add('active');
            };
            
            utterance.onend = function() {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.remove('active');
            };
            
            window.speechSynthesis.speak(utterance);
        } else {
            showToast('warning', 'Tidak Didukung', 'Browser tidak mendukung text-to-speech');
        }
    };

    // ==================== MESSAGE ACTIONS ====================
    window.copyMessage = function(btn) {
        const messageBody = btn.closest('.msg-body').querySelector('.post-body');
        const text = messageBody.textContent || messageBody.innerText;
        
        navigator.clipboard.writeText(text).then(() => {
            btn.innerHTML = '<i class="fas fa-check"></i>';
            showToast('success', 'Tersalin!', 'Teks berhasil disalin ke clipboard');
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        }).catch(() => {
            showToast('error', 'Gagal', 'Tidak dapat menyalin teks');
        });
    };

    window.copyCode = function(btn) {
        const codeBlock = btn.closest('pre').querySelector('code');
        const code = codeBlock.textContent;
        
        navigator.clipboard.writeText(code).then(() => {
            btn.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-copy"></i> Salin';
                btn.classList.remove('copied');
            }, 2000);
        });
    };

    window.likeMessage = function(btn) {
        btn.classList.toggle('liked');
        const isLiked = btn.classList.contains('liked');
        
        if (isLiked) {
            btn.innerHTML = '<i class="fas fa-heart"></i>';
            showToast('success', 'Disukai!', 'Jawaban telah ditandai');
            playSound('like');
        } else {
            btn.innerHTML = '<i class="far fa-heart"></i>';
        }
    };

    window.shareMessage = function(btn) {
        const messageBody = btn.closest('.msg-body').querySelector('.post-body');
        const text = messageBody.textContent || messageBody.innerText;
        
        if (navigator.share) {
            navigator.share({
                title: 'Santrilogy AI',
                text: text.substring(0, 200) + '...',
                url: window.location.href
            }).then(() => {
                showToast('success', 'Berhasil', 'Berhasil dibagikan');
            }).catch(() => {});
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                showToast('info', 'Link Tersalin', 'Silakan paste untuk berbagi');
            });
        }
    };

    window.regenerateMessage = function(btn) {
        showToast('info', 'Fitur Segera Hadir', 'Regenerate akan tersedia di update berikutnya');
    };

    // ==================== CHAT MANAGEMENT ====================
    window.startNewChat = function() {
        // Clear chat container
        const container = document.getElementById('chatContainer');
        container.innerHTML = `
            <div class="welcome" id="welcomeScreen">
                <div class="welcome-glow"></div>
                <div class="welcome-logo">
                    <div class="atom-logo atom-lg">
                        <div class="atom-nucleus"></div>
                        <div class="atom-orbit orbit-1"></div>
                        <div class="atom-orbit orbit-2"></div>
                        <div class="atom-orbit orbit-3"></div>
                    </div>
                </div>
                <h1>Santrilogy AI</h1>
                <p class="subtitle">Assalamualaikum! Saya siap membantu kajian kitab kuning, nahwu, shorof, fikih, dan ilmu keislaman lainnya.</p>
                
                <div class="quick-actions">
                    <button class="quick-action" onclick="startVoiceChat()">
                        <i class="fas fa-microphone"></i>
                        <span>Mulai dengan Suara</span>
                    </button>
                    <button class="quick-action" onclick="uploadImage()">
                        <i class="fas fa-camera"></i>
                        <span>Scan Kitab</span>
                    </button>
                </div>

                <div class="suggestions">
                    <div class="sug-card" onclick="askQuestion('Jelaskan hukum air musta\\'mal dalam fikih Syafi\\'i')">
                        <div class="sug-icon"><i class="fas fa-water"></i></div>
                        <div class="sug-title">Fikih Thaharah</div>
                        <div class="sug-desc">Hukum air musta'mal dan pembagiannya</div>
                    </div>
                    <div class="sug-card" onclick="askQuestion('Terjemahkan dan jelaskan Fathul Qorib Bab Wudhu')">
                        <div class="sug-icon"><i class="fas fa-book"></i></div>
                        <div class="sug-title">Terjemah Kitab</div>
                        <div class="sug-desc">Fathul Qorib, Safinatun Najah, dll</div>
                    </div>
                    <div class="sug-card" onclick="askQuestion('Berikan analisis i\\'rob dari bait pertama Alfiyah Ibn Malik')">
                        <div class="sug-icon"><i class="fas fa-diagram-project"></i></div>
                        <div class="sug-title">Analisis I'rob</div>
                        <div class="sug-desc">Nahwu dan struktur kalimat Arab</div>
                    </div>
                    <div class="sug-card" onclick="askQuestion('Jelaskan wazan fi\\'il dan tasrif lughowi')">
                        <div class="sug-icon"><i class="fas fa-language"></i></div>
                        <div class="sug-title">Ilmu Shorof</div>
                        <div class="sug-desc">Perubahan bentuk kata Arab</div>
                    </div>
                </div>
            </div>
        `;
        
        closeSidebar();
        showToast('success', 'Chat Baru', 'Percakapan baru dimulai');
        playSound('new');
    };

    window.askQuestion = function(question) {
        const input = document.getElementById('userPrompt');
        input.value = question;
        handleInputChange();
        sendMessage();
    };

    window.clearAllChats = function() {
        if (confirm('Yakin ingin menghapus semua riwayat chat? Tindakan ini tidak dapat dibatalkan.')) {
            localStorage.removeItem('santrilogy_history');
            AppState.chatHistory = [];
            startNewChat();
            closeSettingsModal();
            closeSettingsDropdown();
            showToast('success', 'Dihapus', 'Semua riwayat chat telah dihapus');
        }
    };

    window.exportChats = function() {
        const history = localStorage.getItem('santrilogy_history');
        if (!history) {
            showToast('warning', 'Kosong', 'Tidak ada riwayat chat untuk diekspor');
            return;
        }
        
        const blob = new Blob([history], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `santrilogy_chat_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('success', 'Diekspor', 'Riwayat chat berhasil diunduh');
    };

    window.deleteHistory = function(index) {
        // Implement history deletion
        showToast('success', 'Dihapus', 'Riwayat berhasil dihapus');
    };

    window.viewAllHistory = function() {
        showToast('info', 'Segera Hadir', 'Fitur riwayat lengkap akan segera tersedia');
    };

    // ==================== ADDITIONAL DROPDOWN FUNCTIONS ====================
    window.shareChat = function() {
        closeMoreDropdown();
        
        if (navigator.share) {
            navigator.share({
                title: 'Santrilogy AI',
                text: 'Coba Santrilogy AI untuk belajar ilmu agama!',
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(window.location.href);
            showToast('success', 'Link Tersalin', 'Link berhasil disalin');
        }
    };

    window.pinChat = function() {
        closeMoreDropdown();
        showToast('success', 'Dipin', 'Percakapan berhasil dipin');
    };

    window.renameChat = function() {
        closeMoreDropdown();
        const newName = prompt('Masukkan judul baru:');
        if (newName) {
            showToast('success', 'Diubah', 'Judul berhasil diubah');
        }
    };

    window.downloadApp = function() {
        closeMoreDropdown();
        showToast('info', 'PWA', 'Gunakan menu browser untuk install aplikasi');
    };

    window.showKeyboardShortcuts = function() {
        closeMoreDropdown();
        showToast('info', 'Pintasan Keyboard', 
            'Ctrl+K: Chat Baru\nCtrl+/: Toggle Sidebar\nEnter: Kirim\nShift+Enter: Baris Baru');
    };

    window.showPrivacyPolicy = function() {
        closeMoreDropdown();
        showToast('info', 'Kebijakan Privasi', 'Data Anda aman dan tidak dibagikan ke pihak ketiga');
    };

    window.showTerms = function() {
        closeMoreDropdown();
        showToast('info', 'Syarat & Ketentuan', 'Gunakan Santrilogy AI dengan bijak dan bertanggung jawab');
    };

    window.showAbout = function() {
        closeMoreDropdown();
        showToast('info', 'Tentang Santrilogy', `Versi ${CONFIG.VERSION}\nDikembangkan untuk para santri dan pecinta ilmu`);
    };

    window.showDisclaimer = function() {
        showToast('warning', 'Disclaimer', 
            'AI bisa keliru. Selalu verifikasi jawaban dengan guru/ustadz yang kompeten.');
    };

    window.toggleSearch = function() {
        showToast('info', 'Pencarian', 'Fitur pencarian akan segera tersedia');
    };

    window.showNotifications = function() {
        showToast('info', 'Notifikasi', 'Tidak ada notifikasi baru');
    };

    window.showUpgradeModal = function() {
        closeSidebar();
        showToast('info', 'Upgrade Pro', 'Fitur premium dengan akses tak terbatas akan segera hadir!');
    };

    window.showHelpModal = function() {
        closeSidebar();
        showToast('info', 'Bantuan', 'Hubungi kami di support@santrilogy.ai');
    };

    window.toggleEmojiPicker = function() {
        showToast('info', 'Emoji', 'Emoji picker akan segera tersedia');
    };

    // ==================== UTILITY FUNCTIONS ====================
    function closeAllModals() {
        closeToolsModal();
        closeSettingsModal();
        closeWritingModal();
        closeAdminModal();
        closeMoreDropdown();
        closeModelDropdown();
        closeSettingsDropdown();
        closeToolsDropdown();
    }

    function saveSettings() {
        const settings = {
            darkMode: AppState.isDarkMode,
            ...AppState.settings
        };
        localStorage.setItem('santrilogy_settings', JSON.stringify(settings));
    }

    function loadSettings() {
        try {
            const saved = localStorage.getItem('santrilogy_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                
                // Apply dark mode
                if (settings.darkMode) {
                    AppState.isDarkMode = true;
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.querySelectorAll('#darkToggleDesktop, #darkToggleMobile').forEach(el => {
                        if (el) el.classList.add('on');
                    });
                }
                
                // Apply theme color
                if (settings.themeColor) {
                    document.documentElement.style.setProperty('--accent', settings.themeColor);
                }
                
                // Apply font size
                if (settings.fontSize) {
                    const sizes = { 'small': '14px', 'medium': '15px', 'large': '17px' };
                    document.documentElement.style.setProperty('--font-base', sizes[settings.fontSize]);
                }
                
                // Merge settings
                AppState.settings = { ...AppState.settings, ...settings };
            }
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }

    function saveToHistory(question, answer) {
        try {
            let history = JSON.parse(localStorage.getItem('santrilogy_history') || '[]');
            history.unshift({
                id: Date.now(),
                question: question.substring(0, 100),
                answer: answer.substring(0, 200),
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 items
            history = history.slice(0, 50);
            localStorage.setItem('santrilogy_history', JSON.stringify(history));
            
            // Update storage indicator
            updateStorageIndicator(history.length);
        } catch (e) {
            console.error('Error saving history:', e);
        }
    }

    function updateStorageIndicator(count) {
        const max = 50;
        const percentage = (count / max) * 100;
        
        const valueEl = document.getElementById('storageValue');
        const fillEl = document.getElementById('storageFill');
        
        if (valueEl) valueEl.textContent = `${count}/${max} chat`;
        if (fillEl) fillEl.style.width = `${percentage}%`;
    }

    // ==================== TOAST NOTIFICATIONS ====================
    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-times-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type]}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // ==================== SOUND EFFECTS ====================
    function playSound(type) {
        if (!AppState.settings.soundEnabled) return;
        
        // Using Web Audio API for simple sounds
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            const sounds = {
                send: { freq: 800, duration: 0.1 },
                receive: { freq: 600, duration: 0.15 },
                like: { freq: 1000, duration: 0.1 },
                new: { freq: 500, duration: 0.2 }
            };
            
            const sound = sounds[type] || sounds.send;
            
            oscillator.frequency.value = sound.freq;
            oscillator.type = 'sine';
            gainNode.gain.value = 0.1;
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + sound.duration);
        } catch (e) {
            // Sound not supported
        }
    }

    // ==================== PWA SETUP ====================
    function setupPWA() {
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or toast after delay
            setTimeout(() => {
                showToast('info', 'Install Aplikasi', 'Tambahkan Santrilogy ke home screen untuk akses cepat');
            }, 10000);
        });
        
        window.addEventListener('appinstalled', () => {
            showToast('success', 'Terinstall!', 'Santrilogy AI berhasil ditambahkan ke device Anda');
        });
    }

    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // Register service worker if available
            // navigator.serviceWorker.register('/sw.js');
        });
    }

    // ==================== INITIALIZE ====================
    console.log('%cðŸ•Œ Santrilogy AI', 'font-size: 24px; font-weight: bold; color: #6366f1;');
    console.log('%cIlmu untuk Umat', 'font-size: 14px; color: #8b5cf6;');

    //]]>
    </script>

    <!-- PWA Manifest -->
    <link href='/manifest.json' rel='manifest'/>
    <meta content='#6366f1' name='theme-color'/>
    <link href='/icons/icon-192.png' rel='apple-touch-icon'/>

    <!-- Preconnect for performance -->
    <link href='https://fonts.googleapis.com' rel='preconnect'/>
    <link crossorigin='anonymous' href='https://fonts.gstatic.com' rel='preconnect'/>
    <link href='https://cdnjs.cloudflare.com' rel='preconnect'/>
  </body>
</html>