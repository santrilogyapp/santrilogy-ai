/**
 * SANTRILOGY AI CORE
 * Menghubungkan Blogger dengan Supabase Edge Functions
 */

// KONFIGURASI (Aman ditaruh di sini karena Anon Key hanya untuk akses publik)
const CONFIG = {
    FUNCTION_URL: "https://jbbathydxvpgmgtauadm.supabase.co/functions/v1/chat-engine", // Ganti dengan URL Deploy tadi
    SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiYmF0aHlkeHZwZ21ndGF1YWRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MTMyNjMsImV4cCI6MjA4MDA4OTI2M30.9uUtMwX4G5gmhbFHv1l7DgNTedQtiWqSzZ_VgWYzFAo" // Ambil dari Dashboard Supabase -> Settings -> API
};

// Fungsi Utama: Mengirim Pesan
async function chatWithSantrilogy(userMessage) {
    try {
        console.log("Mengirim pesan ke Santrilogy...", userMessage);

        const response = await fetch(CONFIG.FUNCTION_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
                prompt: userMessage
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data.answer; // Mengembalikan teks jawaban AI

    } catch (error) {
        console.error("Santrilogy Error:", error);
        return "Maaf kawan, sedang ada gangguan koneksi ke server pusat.";
    }
}

// Fungsi Helper untuk UI (Dipanggil dari tombol kirim XML)
async function handleUserSend() {
    const inputField = document.getElementById('userPrompt');
    const chatContainer = document.getElementById('main-chat-area');
    
    const text = inputField.value;
    if (!text) return;

    // 1. Tampilkan Chat User di UI
    addBubble(text, 'user');
    inputField.value = ''; // Kosongkan input

    // 2. Tampilkan Loading Skeleton
    const loadingId = addLoadingBubble();

    // 3. Panggil AI
    const aiResponse = await chatWithSantrilogy(text);

    // 4. Hapus Loading, Tampilkan Jawaban AI
    removeLoadingBubble(loadingId);
    addBubble(aiResponse, 'ai');
}

// --- FUNGSI UI SEDERHANA (Manipulasi DOM) ---
function addBubble(text, type) {
    const div = document.createElement('div');
    div.className = type === 'user' ? 'post-outer user-bubble' : 'post-outer ai-bubble';
    // Gunakan Marked.js jika ingin support Markdown (Bold/Italic)
    div.innerHTML = `<div class="post-body">${text}</div>`; 
    document.getElementById('main').appendChild(div);
    
    // Auto Scroll
    document.getElementById('main-chat-area').scrollTop = document.getElementById('main-chat-area').scrollHeight;
}

function addLoadingBubble() {
    const id = 'loading-' + Date.now();
    const div = document.createElement('div');
    div.id = id;
    div.className = 'post-outer ai-bubble';
    div.innerHTML = `<div class="post-body">Sedang membuka kitab...</div>`;
    document.getElementById('main').appendChild(div);
    return id;
}

function removeLoadingBubble(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}