
// santrilogy-core.min.js - Optimized core functionality for Santrilogy AI
// Includes essential functions for authentication, chat, and specialized features

// Define namespace
window.SantrilogyCore = (function() {
    'use strict';
    
    // Konfigurasi Supabase
    const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content || 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]')?.content || 'YOUR_SUPABASE_ANON_KEY';

    // Inisialisasi client Supabase
    const supabase = typeof supabase !== 'undefined' ? 
        supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // API Wrapper untuk Supabase
    const SantrilogyAPI = {
        // Fungsi autentikasi
        auth: {
            getCurrentUser: async function() {
                if (!supabase) return null;
                try {
                    const { data: { user }, error } = await supabase.auth.getUser();
                    if (error) throw error;
                    return user;
                } catch (error) {
                    console.error('Get current user error:', error);
                    return null;
                }
            }
        },
        
        // Fungsi manajemen chat
        chat: {
            getUserChatSessions: async function(userId, limit = 50, offset = 0) {
                if (!supabase) return { success: false, error: 'Supabase not initialized' };
                try {
                    const { data, error, count } = await supabase
                        .from('chat_sessions')
                        .select(`
                            id, 
                            title, 
                            created_at, 
                            updated_at, 
                            metadata
                        `, { count: 'exact' })
                        .eq('user_id', userId)
                        .order('updated_at', { ascending: false })
                        .range(offset, offset + limit - 1);

                    if (error) throw error;

                    // Ambil jumlah pesan untuk setiap sesi
                    const sessionIds = data?.map(session => session.id) || [];
                    let messagesCount = {};
                    
                    if (sessionIds.length > 0) {
                        const { data: messageCounts, error: countError } = await supabase
                            .from('messages')
                            .select('session_id', { count: 'exact', groupedBy: 'session_id' })
                            .in('session_id', sessionIds);

                        if (!countError && messageCounts) {
                            messageCounts.forEach(mc => {
                                messagesCount[mc.session_id] = mc.count || 0;
                            });
                        }
                    }
                    
                    // Tambahkan jumlah pesan ke setiap sesi
                    if (data) {
                        data.forEach(session => {
                            session.messageCount = messagesCount[session.id] || 0;
                        });
                    }

                    return { success: true, data, total: count };
                } catch (error) {
                    console.error('Get user chat sessions error:', error);
                    return { success: false, error: error.message };
                }
            },
            
            saveMessage: async function(sessionId, userId, role, content, parentMessageId = null) {
                if (!supabase) return { success: false, error: 'Supabase not initialized' };
                try {
                    // Perbarui waktu terakhir sesi diakses
                    await supabase
                        .from('chat_sessions')
                        .update({ updated_at: new Date().toISOString() })
                        .eq('id', sessionId)
                        .eq('user_id', userId);

                    const { data, error } = await supabase
                        .from('messages')
                        .insert([{ 
                            session_id: sessionId, 
                            user_id: userId, 
                            role: role,
                            content: content,
                            parent_message_id: parentMessageId
                        }])
                        .select()
                        .single();

                    if (error) throw error;

                    return { success: true, data };
                } catch (error) {
                    console.error('Save message error:', error);
                    return { success: false, error: error.message };
                }
            }
        }
    };

    // Backend Santrilogy
    const SantrilogyBackend = {
        // Operasi sesi
        sessionOp: async function(sessionId, userId, action, sessionData = null) {
            if (!supabase) return { success: false, error: 'Supabase not initialized' };
            try {
                if (action === 'save' && sessionData) {
                    const { data: existingSession, error: fetchError } = await supabase
                        .from('chat_sessions')
                        .select('*')
                        .eq('id', sessionId)
                        .eq('user_id', userId)
                        .single();

                    if (fetchError && fetchError.code !== 'PGRST116') {
                        throw fetchError;
                    }

                    if (existingSession) {
                        const { error } = await supabase
                            .from('chat_sessions')
                            .update({ 
                                title: sessionData.title,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', sessionId)
                            .eq('user_id', userId);

                        if (error) throw error;
                    } else {
                        const { error } = await supabase
                            .from('chat_sessions')
                            .insert([{
                                id: sessionId,
                                user_id: userId,
                                title: sessionData.title,
                                metadata: { created_with: 'santrilogy-ai' }
                            }]);

                        if (error) throw error;
                    }

                    return { success: true };
                }
                else if (action === 'get') {
                    const { data, error } = await supabase
                        .from('chat_sessions')
                        .select('*')
                        .eq('id', sessionId)
                        .eq('user_id', userId)
                        .single();

                    if (error) throw error;

                    return { success: true, data };
                }
                else if (action === 'delete') {
                    const { error } = await supabase
                        .from('chat_sessions')
                        .delete()
                        .eq('id', sessionId)
                        .eq('user_id', userId);

                    if (error) throw error;

                    return { success: true };
                }

                return { success: false, error: 'Invalid action' };
            } catch (error) {
                console.error('Session operation error:', error);
                return { success: false, error: error.message };
            }
        },

        // Operasi autentikasi
        authOp: async function(action, email = null, password = null) {
            if (!supabase) return { success: false, error: 'Supabase not initialized' };
            try {
                if (action === 'login' && email && password) {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email, password
                    });
                    if (error) throw error;
                    return { success: true, data };
                } else if (action === 'register' && email && password) {
                    const { data, error } = await supabase.auth.signUp({
                        email, password,
                        options: {
                            data: { 
                                username: email.split('@')[0],
                                full_name: email.split('@')[0]
                            }
                        }
                    });
                    if (error) throw error;
                    
                    // Simpan data pengguna tambahan ke tabel users
                    if (data.user) {
                        await supabase
                            .from('users')
                            .insert([{
                                id: data.user.id,
                                email: data.user.email,
                                username: email.split('@')[0],
                                full_name: email.split('@')[0]
                            }]);
                    }
                    
                    return { success: true, data };
                } else if (action === 'logout') {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    return { success: true };
                } else if (action === 'loginGoogle') {
                    const { error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    });
                    if (error) throw error;
                    return { success: true };
                }

                return { success: false, error: 'Invalid auth action or missing credentials' };
            } catch (error) {
                console.error('Auth operation error:', error);
                return { success: false, error: error.message };
            }
        }
    };

    // Fungsi untuk menghubungkan ke backend AI
    async function callSantrilogyBackend(message, userId, sessionId) {
        try {
            const requestBody = {
                message: message,
                userId: userId,
                sessionId: sessionId,
            };
            
            const response = await fetch('/api/santrilogy-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`Backend API error: ${response.status}`);
            }
            
            const result = await response.json();
            
            return {
                success: true,
                text: result.response || result.text || 'Respons dari AI tidak ditemukan',
            };
        } catch (error) {
            console.error('Error calling Santrilogy backend:', error);
            return {
                success: false,
                error: error.message,
                text: `Maaf, terjadi kesalahan saat memproses permintaan Anda: ${error.message}`
            };
        }
    }

    // Wrapper fungsi-fungsi untuk kompatibilitas
    const firebaseFunctions = {
        firebaseLoadHistory: async function() {
            const user = await SantrilogyAPI.auth.getCurrentUser();
            if (!user) return [];
            const result = await SantrilogyAPI.chat.getUserChatSessions(user.id);
            return result.success ? result.data : [];
        },

        firebaseSaveSession: async function(sessionId, userId, title, messages) {
            if (!sessionId || !userId) return false;
            const result = await SantrilogyBackend.sessionOp(sessionId, userId, 'save', { title, messages });
            return result.success;
        },

        firebaseLoadSession: async function(sessionId, userId) {
            if (!sessionId || !userId) return null;
            const result = await SantrilogyBackend.sessionOp(sessionId, userId, 'get');
            return result.success ? result.data : null;
        },

        firebaseDeleteSession: async function(sessionId, userId) {
            if (!sessionId || !userId) return false;
            if (!supabase) return false;
            const { error } = await supabase
                .from('chat_sessions')
                .delete()
                .eq('id', sessionId)
                .eq('user_id', userId);
            return !error;
        },

        firebaseEmailAuth: async function(email, password, authMode) {
            try {
                let response;
                if (authMode === 'register') {
                    response = await SantrilogyBackend.authOp('register', email, password);
                } else {
                    response = await SantrilogyBackend.authOp('login', email, password);
                }

                if (response.success) {
                    if (window.SantrilogyApp && typeof window.SantrilogyApp.updateUserUI === 'function') {
                        const user = await SantrilogyAPI.auth.getCurrentUser();
                        window.SantrilogyApp.updateUserUI(user || {
                            id: response.data?.user?.id || 'user_' + Date.now(),
                            email: email,
                            user_name: email.split('@')[0]
                        });

                        if (typeof window.SantrilogyApp.closeModal === 'function') {
                            window.SantrilogyApp.closeModal('authModal');
                        }

                        if (typeof window.SantrilogyApp.showToast === 'function') {
                            const successMsg = authMode === 'register' ? "Akun berhasil dibuat! ðŸŽ‰" : "Selamat datang kembali! ðŸ‘‹";
                            window.SantrilogyApp.showToast(successMsg, "success");
                        }
                    }
                    return response;
                } else {
                    throw new Error(response.error || 'Authentication failed');
                }
            } catch (error) {
                console.error('Supabase authentication error:', error);
                if (window.SantrilogyApp && typeof window.SantrilogyApp.showToast === 'function') {
                    window.SantrilogyApp.showToast(error.message || 'Gagal melakukan autentikasi', 'error');
                }
                throw error;
            }
        },

        firebaseGoogleAuth: async function() {
            try {
                const response = await SantrilogyBackend.authOp('loginGoogle');
                
                if (response.success) {
                    if (window.SantrilogyApp && typeof window.SantrilogyApp.showToast === 'function') {
                        window.SantrilogyApp.showToast("Berhasil masuk dengan Google! ðŸ‘‹", "success");
                    }
                    return response;
                } else {
                    throw new Error(response.error || 'Google authentication failed');
                }
            } catch (error) {
                console.error('Supabase Google auth error:', error);
                if (window.SantrilogyApp && typeof window.SantrilogyApp.showToast === 'function') {
                    window.SantrilogyApp.showToast(error.message || 'Gagal masuk dengan Google', 'error');
                }
                throw error;
            }
        },

        firebaseLogout: async function() {
            try {
                const response = await SantrilogyBackend.authOp('logout');
                
                if (response.success) {
                    localStorage.removeItem('santrilogy_user');
                    localStorage.removeItem('santrilogy_user_email');
                    localStorage.removeItem('santrilogy_user_hash');
                    localStorage.removeItem('santrilogy_id_token');
                    localStorage.removeItem('santrilogy_refresh_token');

                    if (window.SantrilogyApp && typeof window.SantrilogyApp.updateUserUI === 'function') {
                        window.SantrilogyApp.updateUserUI(null);
                        if (typeof window.SantrilogyApp.showToast === 'function') {
                            window.SantrilogyApp.showToast("Berhasil logout! ðŸ‘‹", "success");
                        }
                    }
                    
                    return response;
                } else {
                    throw new Error(response.error || 'Logout failed');
                }
            } catch (error) {
                console.error('Supabase logout error:', error);
                if (window.SantrilogyApp && typeof window.SantrilogyApp.showToast === 'function') {
                    window.SantrilogyApp.showToast(error.message || 'Gagal logout', 'error');
                }
                throw error;
            }
        }
    };

    // Fungsi untuk menguji koneksi
    const testConnection = async function() {
        try {
            const user = await SantrilogyAPI.auth.getCurrentUser();
            
            if (user) {
                console.log('âœ“ Supabase connection successful, user authenticated:', user.email);
                return { success: true, user: user };
            } else {
                console.log('âœ“ Supabase connection successful, no user authenticated');
                return { success: true, user: null };
            }
        } catch (error) {
            console.error('âœ— Supabase connection failed:', error.message);
            return { success: false, error: error.message };
        }
    };

    // Return public API
    return {
        supabase: supabase,
        api: SantrilogyAPI,
        backend: SantrilogyBackend,
        firebase: firebaseFunctions,
        testConnection: testConnection,
        callSantrilogyBackend: callSantrilogyBackend
    };
})();

// Setelah modul dimuat, inisialisasi fungsi-fungsi global
document.addEventListener('DOMContentLoaded', async function() {
    // Tambahkan fungsi-fungsi ke window object untuk kompatibilitas
    Object.assign(window, SantrilogyCore.firebase);
    
    // Test koneksi
    const connectionResult = await SantrilogyCore.testConnection();
    
    // Tandai bahwa sistem siap
    window.supabaseReady = connectionResult.success;
    window.santrilogyStatus = {
        supabaseReady: connectionResult.success,
        user: connectionResult.user || null,
        timestamp: new Date().toISOString()
    };
    
    // Tandai bahwa firebase siap (untuk kompatibilitas dengan main.js)
    window.firebaseReady = true;
    
    console.log('Santrilogy Core initialized:', window.santrilogyStatus);
});